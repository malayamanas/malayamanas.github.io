<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WMI Subscription — Event Consumer Created</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<nav class="navbar">
  <a href="index.html" class="nav-back">&#8592; Back to Index</a>
  <span class="nav-title">Sysmon Detection SOP</span>
</nav>
<div class="page-header">
  <h1 class="page-title">WMI Subscription — Event Consumer Created</h1>
  <div class="page-meta">
    <span class="badge badge-high">High</span>
    <span class="meta-item"><strong>Sysmon Event IDs:</strong> 1,19,20,21</span>
    <span class="meta-item"><strong>Tactics:</strong> Execution | Persistence</span>
  </div>
  <div class="page-tags"><span class="tag-pill">persistence</span> <span class="tag-pill">execution</span> <span class="tag-pill">t1546.003</span></div>
</div>
<main class="content">
<hr>

<strong>Sysmon Detection – Attack Technique Profile</strong>

<strong>Document Version:</strong> 1.0
<strong>Date:</strong> February 2026
<strong>Usecase ID / Name:</strong> WMI Subscription — Event Consumer Created

<h3 id="1-technique-summary">1. Technique Summary</h3>

<table>
<thead>
<tr><th>Field</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td><strong>Usecase Name</strong></td><td>WMI Subscription — Event Consumer Created</td></tr>
<tr><td><strong>Primary Sysmon Event ID(s)</strong></td><td>1 (Process Creation), 19 (WmiEvent (EventFilter Activity)), 20 (WmiEvent (EventConsumer Activity)), 21 (WmiEvent (ConsumerToFilter Activity))</td></tr>
<tr><td><strong>MITRE ATT&amp;CK Technique ID</strong></td><td>T1546.003</td></tr>
<tr><td><strong>MITRE Tactic(s)</strong></td><td>Execution, Persistence</td></tr>
<tr><td><strong>Detection Level</strong></td><td>High</td></tr>
<tr><td><strong>Log Source</strong></td><td>Sysmon (System Monitor) Event Log</td></tr>
<tr><td><strong>Logsource Category</strong></td><td>sysmon</td></tr>
<tr><td><strong>Tags</strong></td><td>persistence, execution, t1546.003</td></tr>
</tbody></table>

<strong>Short Description</strong>
An adversary runs attacker-controlled code on the target system through WMI Subscription — Event Consumer Created. Sysmon Event(s) 1, 19, 20, 21 (Process Creation, WmiEvent (EventFilter Activity), WmiEvent (EventConsumer Activity), WmiEvent (ConsumerToFilter Activity)) provide the primary Sysmon-layer detection signal for this technique.

<h3 id="2-mitre-attck-mapping">2. MITRE ATT&amp;CK Mapping</h3>

<p><ul>
  <li><strong>Tactic</strong>     : Execution  </li>
</ul><br>
  <strong>Technique</strong> : T1546.003 (T1546.003)</p>

<h3 id="3-how-the-attack-typically-works-procedure">3. How the Attack Typically Works (Procedure)</h3>

<ol>
  <li>Attacker authenticates to the target host using stolen credentials (pass-the-hash or plaintext).</li>
  <li>WMI queries or Win32_Process create calls are issued remotely via the DCOM/RPC transport — Sysmon Event 3 captures the DCOM network connection on port 135 and dynamic ports.</li>
  <li>The remote WMI call spawns a new process on the target — Sysmon Event 1 captures the spawned process (parent: WmiPrvSE.exe or svchost -k netsvcs).</li>
  <li>For WMI persistence, Sysmon Events 19, 20, and 21 fire when the event filter, consumer, and binding are created.</li>
  <li>The spawned process executes the attacker&#x27;s command (PowerShell download cradle, reverse shell, or reconnaissance command).</li>
</ol>

<strong>Most common tools observed in 2024–2026:</strong>
<ul>
  <li>Impacket wmiexec.py</li>
  <li>CobaltStrike WMI lateral movement</li>
  <li>PowerShell Invoke-WmiMethod</li>
  <li>WMIS / wmic.exe (native)</li>
</ul>

<h3 id="4-key-sysmon-event-indicators">4. Key Sysmon Event Indicators</h3>

<h4 id="sysmon-event-1-process-creation">Sysmon Event 1 — Process Creation</h4>

<p>A new process was created. Captures image path, command line, parent, hashes, user, and integrity level.</p>

<table>
<thead>
<tr><th>Field</th><th>Suspicious Value / Pattern</th><th>Why It Matters</th></tr>
</thead>
<tbody>
<tr><td><strong>Image</strong></td><td>wmic.exe, powershell.exe (Invoke-WmiMethod, New-CimInstance), mofcomp.exe, scrcons.exe</td><td>WMI execution and subscription tools; mofcomp.exe registering MOF files and PowerShell WMI cmdlets indicate WMI persistence setup</td></tr>
<tr><td><strong>CommandLine</strong></td><td>Encoded commands (-EncodedCommand, -enc), LOLBin abuse flags (certutil -decode, mshta http://), credential access arguments (sekurlsa, lsadump, pth)</td><td>Full command line reveals exact attacker intent; encoded or obfuscated arguments are critical IOCs</td></tr>
<tr><td><strong>ParentImage</strong></td><td>Office apps (winword.exe, excel.exe) spawning PowerShell/cmd; browsers spawning cmd; svchost.exe spawning unexpected children; w3wp.exe (IIS) spawning shells</td><td>Abnormal parent-child relationships reveal the initial execution vector (macro, exploit, injection)</td></tr>
<tr><td><strong>ParentCommandLine</strong></td><td>Encoded PowerShell from Office; mshta.exe launching script; wscript.exe executing remote content</td><td>Parent&#x27;s full command clarifies the delivery mechanism and payload stage</td></tr>
<tr><td><strong>OriginalFileName</strong></td><td>Mismatch between Image filename and OriginalFileName field (e.g., Image=svchost.exe but OriginalFileName=mimikatz.exe)</td><td>Catches renamed attacker tools that attempt to masquerade as legitimate Windows binaries</td></tr>
<tr><td><strong>Hashes</strong></td><td>Known malware hashes (cross-reference threat intelligence feeds); unsigned binaries with high-entropy names</td><td>Hash-based detection is immune to filename changes; enables instant enrichment with threat intelligence</td></tr>
<tr><td><strong>IntegrityLevel</strong></td><td>High or System from a process spawned by a low-privilege parent; elevation without UAC prompt context</td><td>Indicates whether the process ran with elevated privileges; unexpected elevation reveals bypass techniques</td></tr>
<tr><td><strong>User</strong></td><td>SYSTEM-context processes from interactive user sessions; service accounts launching interactive processes</td><td>Process owner; unexpected user context for a given image path indicates impersonation or privilege escalation</td></tr>
</tbody></table>

<h4 id="sysmon-event-19-wmievent-eventfilter-activity">Sysmon Event 19 — WmiEvent (EventFilter Activity)</h4>

<p>A WMI event filter subscription was created. First leg of WMI persistence subscription.</p>

<table>
<thead>
<tr><th>Field</th><th>Suspicious Value / Pattern</th><th>Why It Matters</th></tr>
</thead>
<tbody>
<tr><td><strong>Name</strong></td><td>Random or GUID-like filter names; names mimicking legitimate WMI filters (e.g., SCM Event Log Filter); names used by known malware (BotFilter, PowerShell Event Filter)</td><td>WMI event filter name; random names and names mimicking legitimate filters identify malicious WMI persistence subscriptions</td></tr>
<tr><td><strong>Query</strong></td><td>EventNamespace=&#x27;root\\subscription&#x27; or &#x27;root\\cimv2&#x27;; queries triggering on startup (Win32_ComputerShutdownEvent), user logon (Win32_LogonSession), or timer (WITHIN 10)</td><td>WMI query that triggers the event; timing-based or logon-triggered queries in persistence namespaces confirm malicious WMI subscription behavior</td></tr>
<tr><td><strong>Image</strong></td><td>powershell.exe, mofcomp.exe, scrcons.exe, wmic.exe creating WMI subscriptions; non-management-tool processes registering WMI event filters</td><td>Process creating the WMI event filter; scripting engines and shells should not normally create WMI event subscriptions</td></tr>
</tbody></table>

<h4 id="sysmon-event-20-wmievent-eventconsumer-activity">Sysmon Event 20 — WmiEvent (EventConsumer Activity)</h4>

<p>A WMI event consumer was created. Second leg of WMI persistence subscription.</p>

<table>
<thead>
<tr><th>Field</th><th>Suspicious Value / Pattern</th><th>Why It Matters</th></tr>
</thead>
<tbody>
<tr><td><strong>Name</strong></td><td>Random or attacker-generated names; names matching known malware WMI consumers (e.g., PowerShell Consumer, SCM Event Log Consumer)</td><td>WMI event consumer name; pairs with the event filter (Sysmon 19) to form a complete persistence subscription</td></tr>
<tr><td><strong>Type</strong></td><td>CommandLineEventConsumer (executes a command — highest risk), ActiveScriptEventConsumer (executes script), LogFileEventConsumer (less harmful)</td><td>Consumer type determines the action taken when the trigger fires; CommandLine and ActiveScript consumers execute attacker payloads</td></tr>
<tr><td><strong>Destination</strong></td><td>PowerShell -EncodedCommand payloads; cmd.exe /c with encoded arguments; paths in %TEMP%/%AppData%; UNC paths to attacker infrastructure</td><td>The command or script that will execute when the event fires; this is the actual malicious payload stored in the WMI consumer</td></tr>
</tbody></table>

<h4 id="sysmon-event-21-wmievent-consumertofilter-activity">Sysmon Event 21 — WmiEvent (ConsumerToFilter Activity)</h4>

<p>A WMI consumer was bound to an event filter. Third leg completing a WMI persistence subscription.</p>

<table>
<thead>
<tr><th>Field</th><th>Suspicious Value / Pattern</th><th>Why It Matters</th></tr>
</thead>
<tbody>
<tr><td><strong>Consumer</strong></td><td>Consumer names matching Sysmon 20 entries from the same timeframe; names indicating persistence (PowerShell Consumer, ScriptConsumer)</td><td>Which consumer this binding activates; completing the triple (filter → binding → consumer) confirms a full WMI persistence subscription is active</td></tr>
<tr><td><strong>Filter</strong></td><td>Filter names matching Sysmon 19 entries; binding unknown filter names to known-suspicious consumers</td><td>Which event filter triggers this consumer; the binding event (21) is the final step that activates WMI persistence — its appearance confirms the subscription is live</td></tr>
</tbody></table>

<h3 id="5-detection-hunting-recommendations">5. Detection / Hunting Recommendations</h3>

<strong>Strong / Classic Signature Rule (High Confidence)</strong>
<ul>
  <li>Alert on Sysmon event(s) 1, 19, 20, 21 matching the field combinations shown in Section 4</li>
  <li>Apply environment-specific thresholds: a single matching event may be sufficient for critical-level detections</li>
</ul>

<strong>Sigma Detection Rule (YAML skeleton):</strong>
<pre><code class="language-yaml">title: WMI Subscription — Event Consumer Created
status: experimental
logsource:
    category: process_creation  # adjust per primary Sysmon event type
    product: windows
detection:
    selection:
    EventID: 1  # Sysmon Process Creation
    Image|endswith|any:
      - &#x27;\\mofcomp.exe&#x27;
      - &#x27;\\wmic.exe&#x27;
    CommandLine|contains|any:
      - &#x27;subscription&#x27;
      - &#x27;eventfilter&#x27;
      - &#x27;__EventFilter&#x27;
    condition: selection
level: high
tags:
    - persistence
    - execution
    - t1546.003
</code></pre>

<strong>Contextual / Behavioral Hunting Queries (SIEM / EDR)</strong>
<ul>
  <li>Hunt for <code>Sysmon 1 / Sysmon 19 / Sysmon 20 / Sysmon 21</code> events where Image is NOT in the approved software baseline</li>
  <li>Alert on Sysmon 1 / Sysmon 19 / Sysmon 20 / Sysmon 21 from accounts in privileged groups outside approved maintenance windows</li>
  <li>Correlate Sysmon 1 events with subsequent Windows Security 4624/4625 events to link process activity to authentication events</li>
  <li>Stack-rank <code>Sysmon 1 / Sysmon 19 / Sysmon 20 / Sysmon 21</code> events by Image path to identify rare/novel executables across the fleet</li>
</ul>

<strong>False Positive Considerations</strong>
<ul>
  <li>Legitimate administrative operations by IT staff may generate similar Sysmon events</li>
  <li>Authorized enterprise management platforms performing identical operations</li>
  <li>Security scanning and vulnerability assessment tools in approved assessment windows</li>
  <li>Development and testing environments running attack simulation frameworks</li>
</ul>

<strong>Recommended Hardening (Prevention &amp; Impact Reduction)</strong>
<ul>
  <li>Apply Principle of Least Privilege: restrict the ability to perform this attack to the minimum required accounts</li>
  <li>Deploy comprehensive Sysmon configuration (SwiftOnSecurity or Florian Roth config) to capture all relevant events</li>
  <li>Configure SIEM correlation rules to baseline normal Sysmon patterns and alert on deviations</li>
  <li>Enable Microsoft Defender for Endpoint or equivalent EDR for behavioral detection in addition to Sysmon event-based detection</li>
</ul>

<h3 id="6-recommended-response-actions">6. Recommended Response Actions</h3>

<ul>
  <li>Isolate the affected host from the network immediately if active exploitation or lateral movement is confirmed.</li>
  <li>Identify the initiating account (from Sysmon Event 1 User field or Windows Security 4624 correlation) and disable it pending investigation.</li>
  <li>Preserve Sysmon event logs from the affected host(s) before any remediation — export the Microsoft-Windows-Sysmon/Operational channel.</li>
  <li>Correlate the Sysmon events with Windows Security logs using the LogonId field to link process activity to authenticated sessions.</li>
  <li>Identify and remove the persistence mechanism (registry key, scheduled task, service, WMI subscription) from all affected hosts.</li>
  <li>Search for the same persistence IOC (file hash, registry key path and value, task name) across all endpoints in the fleet.</li>
  <li>Review the affected account&#x27;s full Sysmon event history for the past 30 days to understand the full scope of attacker activity.</li>
  <li>Rebuild the affected host from a known-good image if multiple persistence mechanisms or deep kernel-level persistence is suspected.</li>
</ul>

<hr>
</main>
<footer class="page-footer">
  <a href="index.html">&#8592; Back to Index</a>
</footer>
</body>
</html>