<!doctype html><html lang=en><head><title>Scanned HTB - Insane Linux Box Walkthrough :: VAPT Walkthroughs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete walkthrough of Scanned HTB machine featuring chroot jail escape via file descriptor abuse, data exfiltration through syscall logging, and privilege escalation via path hijacking"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://malayamanas.github.io/posts/scanned-htb-walkthrough/><link rel=stylesheet href=https://malayamanas.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://malayamanas.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://malayamanas.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://malayamanas.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://malayamanas.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://malayamanas.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://malayamanas.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://malayamanas.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://malayamanas.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://malayamanas.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://malayamanas.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://malayamanas.github.io/terminal.css><link rel="shortcut icon" href=https://malayamanas.github.io/favicon.png><link rel=apple-touch-icon href=https://malayamanas.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Scanned HTB - Insane Linux Box Walkthrough"><meta property="og:description" content="Complete walkthrough of Scanned HTB machine featuring chroot jail escape via file descriptor abuse, data exfiltration through syscall logging, and privilege escalation via path hijacking"><meta property="og:url" content="https://malayamanas.github.io/posts/scanned-htb-walkthrough/"><meta property="og:site_name" content="VAPT Walkthroughs"><meta property="og:image" content="https://malayamanas.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="HTB"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2025-09-22 05:50:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://malayamanas.github.io/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://malayamanas.github.io/posts/scanned-htb-walkthrough/>Scanned HTB - Insane Linux Box Walkthrough</a></h1><div class=post-meta><time class=post-date>2025-09-22</time></div><span class=post-tags>#<a href=https://malayamanas.github.io/tags/insane-linux/>insane-linux</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/web/>web</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/chroot-escape/>chroot-escape</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/sandbox-escape/>sandbox-escape</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/file-descriptor-abuse/>file-descriptor-abuse</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ptrace/>ptrace</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/path-hijacking/>path-hijacking</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/privilege-escalation/>privilege-escalation</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/django/>django</a>&nbsp;</span><div class=post-content><div><h1 id=scanned-htb---insane-linux-box-walkthrough>Scanned HTB - Insane Linux Box Walkthrough<a href=#scanned-htb---insane-linux-box-walkthrough class=hanchor arialabel=Anchor>#</a></h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/FoQuNsCyQz0?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h3 id=key-exploitation-steps-and-techniques-chronological-order>Key Exploitation Steps and Techniques (Chronological Order)<a href=#key-exploitation-steps-and-techniques-chronological-order class=hanchor arialabel=Anchor>#</a></h3><p>The transcript describes a walkthrough for exploiting the &ldquo;Scanned&rdquo; box on HackTheBox, focusing on escaping a chroot jail in a malware sandbox application, exfiltrating data, gaining user access, and escalating to root via path hijacking. Below is a chronological extraction of the key steps and techniques, based on the narrative:</p><ol><li><p><strong>Reconnaissance and Initial Discovery</strong>:</p><ul><li>Perform an Nmap scan (<code>nmap -sC -sV -oA</code>) to identify open ports: SSH (22) and HTTP (80) running Nginx.</li><li>Access the HTTP site at port 80, revealing a &ldquo;Malware Scanner&rdquo; web app (Django-based) that allows uploading executables for syscall analysis in a sandbox.</li><li>Technique: Basic port scanning and web enumeration to identify the entry point.</li></ul></li><li><p><strong>Testing the Sandbox Functionality</strong>:</p><ul><li>Upload a sample binary (e.g., MSFVenom reverse shell ELF) via the web form and observe the syscall output (e.g., socket/connect failures).</li><li>Download and extract the source code (<code>malscanner.tar.gz</code>), focusing on <code>sandbox.c</code> and <code>tracing.c</code>.</li><li>Analyze the code: The sandbox creates a chroot jail, copies libraries, sets namespaces/capabilities, drops privileges to UID/GID 1001, and uses ptrace to log syscalls to <code>/log</code>.</li><li>Technique: Functional testing of the app and static source code review to understand the sandbox mechanics (e.g., chroot, ptrace for syscall tracing).</li></ul></li><li><p><strong>Identifying Chroot Jail Escape Vulnerability</strong>:</p><ul><li>Note that the parent process (PID 1 in the jail) leaves an open file descriptor (FD 3) to the <code>/jails</code> directory outside the chroot.</li><li>This FD is accessible via <code>/proc/1/fd/3</code> and can be abused for directory traversal (e.g., <code>../etc/passwd</code>) since chroot only isolates the filesystem view without proper FD closure in the parent.</li><li>Technique: Code analysis reveals improper FD handling (<code>close(jails_fd)</code> only in child processes), allowing LFI-like access outside the jail via procfs.</li></ul></li><li><p><strong>Data Exfiltration via Syscall Log Overwrite</strong>:</p><ul><li>Create a C program (e.g., <code>please_subscribe.c</code>) that writes to <code>/out</code>, then renames it to <code>/log</code> (which is world-writable, mode 777).</li><li>Use fwrite to craft 64-byte syscall entries (syscall in first 8 bytes, junk in next 48, data in last 8 as return value).</li><li>Upload the compiled binary; the web app displays the overwritten <code>/log</code> contents, allowing exfiltration of arbitrary data as hex-encoded syscall returns.</li><li>Automate uploads with a Python script using <code>requests</code> to post files and extract/decode output via regex and <code>struct.unpack</code>.</li><li>Technique: Abuse ptrace syscall logging and file overwrite to exfiltrate data from the sandboxed environment.</li></ul></li><li><p><strong>Implementing Directory Listing (LS) Inside the Jail</strong>:</p><ul><li>Create <code>ls.c</code> using <code>opendir/readdir</code> to list directories, writing output to <code>/dir</code>, then reading and encoding it into syscall format for exfil via <code>/log</code>.</li><li>Enhance to <code>ls_sym.c</code> with <code>readlink</code> to follow symlinks (e.g., list FDs in <code>/proc/1/fd</code>).</li><li>Use this to explore the jail filesystem (e.g., <code>/proc</code>, confirming processes: PID 1 sandbox, PID 2 child, PID 3 killer).</li><li>Technique: Custom directory enumeration to map the jailed environment and confirm the open FD vulnerability.</li></ul></li><li><p><strong>Escaping Chroot and Reading Sensitive Files</strong>:</p><ul><li>Create <code>read_file.c</code> to open <code>/proc/1/fd/3/../etc/passwd</code> (or similar traversals) and exfil the contents via the syscall log method.</li><li>Read <code>/etc/passwd</code> to identify users (e.g., &lsquo;clearance&rsquo;, &lsquo;sandbox&rsquo;).</li><li>Traverse to read the Django database (<code>/var/www/malscanner/malscanner.db</code>), exfil it as binary, and extract strings (including an MD5 hash for &lsquo;clearance&rsquo;).</li><li>Technique: Procfs-based chroot escape via open FD, combined with directory traversal for arbitrary file read.</li></ul></li><li><p><strong>Cracking Credentials and Gaining User Access</strong>:</p><ul><li>Extract MD5 hash from the database (<code>clearance:$md5$salt$hash</code>).</li><li>Format for Hashcat (mode 20: md5($salt.$pass)) and crack using rockyou.txt, revealing password &ldquo;onedayillfeellikecrying&rdquo;.</li><li>SSH as &lsquo;clearance&rsquo; using the cracked password.</li><li>Technique: Offline password cracking with Hashcat after file exfiltration.</li></ul></li><li><p><strong>Privilege Escalation to Root via Path Hijacking</strong>:</p><ul><li>As &lsquo;clearance&rsquo;, access <code>/var/www/malscanner/sandbox/sandbox</code> (setuid binary running as root).</li><li>Run the binary with a program (e.g., <code>/bin/su</code>) and a jail name (e.g., &lsquo;ipsec&rsquo;), creating a new chroot jail in <code>/jails/&lt;name></code>.</li><li>Use <code>ldd /bin/su</code> to list required libraries; copy them to a temp dir (<code>/tmp/lib</code>).</li><li>Hijack a library (e.g., <code>libpam_misc.so.0</code>) by compiling a malicious version (<code>libpam_misc.c</code>) with a constructor function (runs before main).</li><li>In the constructor: Set UID/GID to 0, create a setuid bash copy at <code>/proc/1/fd/3/../../tmp/please_subscribe</code>, chown/chmod it to root-owned 4755.</li><li>Upload a sleeper binary (<code>exec_file.c</code>) that sleeps 2 seconds then execs <code>/bin/su</code>.</li><li>Run the sandbox with the sleeper, quickly copy the libraries (including hijacked one) into the jail before execution.</li><li>Execute the created setuid shell with <code>-p</code> flag to gain root (e.g., <code>./please_subscribe -p</code>).</li><li>Technique: Race condition abuse to inject libraries into the jail, library constructor for pre-main code execution, path hijacking on setuid binary to elevate privileges and escape chroot again.</li></ul></li></ol><p>These steps form a chain: initial web exploitation leads to chroot escape and user access, followed by local privesc via the same sandbox binary. The techniques emphasize code analysis, custom C payloads for exfil/escape, and Linux internals (procfs, chroot, setuid, library loading).</p><p>List all the gaps in each service or systems, that can be fixed with either proper source code fix or configuration fix.</p><h3 id=web-application-django-based-malware-scanner>Web Application (Django-based Malware Scanner)<a href=#web-application-django-based-malware-scanner class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Gap: Lack of input validation or restrictions on uploaded binaries leading to sandbox execution of arbitrary code.</strong></p><ul><li>Description: Users can upload any ELF binary, which is executed in the sandbox, potentially allowing malicious payloads if the sandbox is escapable.</li><li>Fix: Source code fix - Implement file type checks, size limits, or static analysis in the Django view handling uploads (e.g., in <code>views.py</code>, add validation using <code>magic</code> library to ensure only benign executables are processed).</li></ul></li><li><p><strong>Gap: Exposure of source code download link.</strong></p><ul><li>Description: The website provides a direct link to download the full source code, aiding attackers in vulnerability discovery.</li><li>Fix: Configuration fix - Remove or password-protect the source code download endpoint in the Nginx configuration (e.g., add <code>auth_basic</code> in the server block for the <code>/source</code> location).</li></ul></li><li><p><strong>Gap: No CSRF protection or session management issues (inferred from easy automation of uploads).</strong></p><ul><li>Description: Uploads can be automated via simple POST requests without tokens, potentially allowing CSRF attacks.</li><li>Fix: Source code fix - Enable CSRF middleware in Django settings (<code>settings.py</code>) and add <code>@csrf_protect</code> decorators to upload views.</li></ul></li></ul><h3 id=sandbox-binary-sandboxc-and-related>Sandbox Binary (sandbox.c and related)<a href=#sandbox-binary-sandboxc-and-related class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Gap: Open file descriptor to /jails directory not closed in parent process.</strong></p><ul><li>Description: FD 3 remains open in PID 1, accessible via /proc/1/fd/3, allowing chroot escape and arbitrary file reads via directory traversal.</li><li>Fix: Source code fix - Close the jails_fd in the parent process after forking, e.g., add <code>close(jails_fd);</code> immediately after the chroot setup in <code>make_jail()</code> function.</li></ul></li><li><p><strong>Gap: World-writable /log file allowing overwrite.</strong></p><ul><li>Description: /log is set to 0777, enabling uploaded binaries to clobber it and exfiltrate data via syscall logs displayed on the web.</li><li>Fix: Source code fix - Change permissions to 0644 or 0600 in <code>do_trace()</code> before writing, e.g., <code>chmod("/log", 0644);</code> after creation.</li></ul></li><li><p><strong>Gap: Insufficient privilege dropping and capability management.</strong></p><ul><li>Description: Binary runs as root initially, drops to UID/GID 1001, but open FDs and procfs allow re-escalation.</li><li>Fix: Source code fix - Use <code>prctl(PR_SET_NO_NEW_PRIVS, 1)</code> to prevent privilege regain, and drop all capabilities with <code>cap_set_proc()</code> after chroot.</li></ul></li><li><p><strong>Gap: Race condition in jail creation and execution.</strong></p><ul><li>Description: Time window between jail creation and binary execution allows external processes to inject files (e.g., libraries) into the jail.</li><li>Fix: Source code fix - Use atomic operations or locking (e.g., flock on jail directory) in <code>make_jail()</code> to prevent modifications during setup.</li></ul></li><li><p><strong>Gap: Library copying into jail without verification.</strong></p><ul><li>Description: Copies system libraries into jail, but allows hijacking if attacker controls the jail contents.</li><li>Fix: Source code fix - Verify library integrity (e.g., via checksums) before copying in <code>copy_libraries()</code>, or use static linking to avoid dynamic libraries.</li></ul></li><li><p><strong>Gap: Ptrace-based syscall logging exposes sensitive register data.</strong></p><ul><li>Description: Logs full registers (64 bytes) including potentially sensitive data, aiding exfiltration.</li><li>Fix: Source code fix - Sanitize or filter logged data in <code>log_syscall()</code>, e.g., mask non-essential registers before writing to /log.</li></ul></li></ul><h3 id=database-sqlite---malscannerdb>Database (SQLite - malscanner.db)<a href=#database-sqlite---malscannerdb class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Gap: Database file stored in web-readable directory with sensitive data.</strong></p><ul><li>Description: File at /var/www/malscanner/malscanner.db contains hashed credentials, readable via chroot escape.</li><li>Fix: Configuration fix - Move database to a non-web directory (e.g., /var/lib/malscanner/) and set ownership to a dedicated user with 0600 permissions via <code>chown</code> and <code>chmod</code>.</li></ul></li><li><p><strong>Gap: Weak password hashing (MD5 with salt).</strong></p><ul><li>Description: Uses MD5, which is crackable offline (e.g., via Hashcat).</li><li>Fix: Source code fix - Upgrade to bcrypt or Argon2 in Django&rsquo;s auth backend (e.g., in <code>settings.py</code>, set <code>PASSWORD_HASHERS</code> to prefer <code>'django.contrib.auth.hashers.Argon2PasswordHasher'</code>).</li></ul></li></ul><h3 id=ssh-service>SSH Service<a href=#ssh-service class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Gap: Weak or exposed user credentials.</strong><ul><li>Description: User &lsquo;clearance&rsquo; password stored in database and crackable, allowing SSH login.</li><li>Fix: Configuration fix - Enforce key-based authentication only by setting <code>PasswordAuthentication no</code> in /etc/ssh/sshd_config and restarting SSH.</li></ul></li></ul><h3 id=overall-system-configuration>Overall System Configuration<a href=#overall-system-configuration class=hanchor arialabel=Anchor>#</a></h3><ul><li><p><strong>Gap: Setuid binary (sandbox) accessible to non-root users.</strong></p><ul><li>Description: /var/www/malscanner/sandbox/sandbox is executable by &lsquo;clearance&rsquo;, allowing privesc via jail manipulation.</li><li>Fix: Configuration fix - Restrict execution to root only via <code>chmod 700 /path/to/sandbox</code> and use sudoers for controlled access.</li></ul></li><li><p><strong>Gap: Insufficient filesystem permissions on /jails.</strong></p><ul><li>Description: Jails directory allows reading/modification by web user, aiding injection attacks.</li><li>Fix: Configuration fix - Set restrictive permissions (e.g., <code>chown root:root /jails; chmod 700 /jails</code>) to prevent non-root access.</li></ul></li><li><p><strong>Gap: No seccomp or AppArmor/SELinux profiles.</strong></p><ul><li>Description: Sandbox lacks kernel-level restrictions, allowing syscalls that aid escapes.</li><li>Fix: Configuration fix - Enable AppArmor profile for the sandbox binary (e.g., create /etc/apparmor.d/sandbox and enforce with <code>aa-enforce</code>), restricting syscalls and file access.</li></ul></li></ul></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>